<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãƒ¡ãƒ¢ / ã‚¿ã‚¹ã‚¯ï¼ˆæœŸé™ã¤ãï¼‰</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin: 24px; }
    .wrap { max-width: 720px; margin: 0 auto; }
    h1 { margin: 0 0 12px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    input[type="text"] { flex: 1; min-width: 220px; padding: 10px; font-size: 16px; }
    input[type="date"] { padding: 10px; font-size: 16px; }
    button { padding: 10px 12px; font-size: 14px; cursor: pointer; }
    ul { list-style: none; padding: 0; margin: 16px 0 0; }
    li { display: flex; align-items: center; gap: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 8px; }
    li.done .text { text-decoration: line-through; opacity: .6; }
    .text { flex: 1; word-break: break-word; }
    .meta { font-size: 12px; color: #666; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid #ddd; margin-left: 6px; }
    .overdue { border-color: #f55; color: #c00; }
    .today { border-color: #fa0; color: #a60; }
    .muted { color: #666; font-size: 12px; margin-top: 10px; }
    .danger { border: 1px solid #f0b; }
    .spacer { height: 4px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ“ ãƒ¡ãƒ¢ / ã‚¿ã‚¹ã‚¯</h1>

    <div class="row">
      <input id="input" type="text" placeholder="ä¾‹ï¼šFirebaseå‹‰å¼· 15åˆ† / è²·ã„ç‰© / ãƒ¡ãƒ¼ãƒ«è¿”ã™" />
      <input id="due" type="date" />
      <button id="addBtn">è¿½åŠ </button>
    </div>

    <div class="spacer"></div>

    <div class="row">
      <button id="sortBtn">æœŸé™ã§ä¸¦ã³æ›¿ãˆ</button>
      <button id="clearDoneBtn">å®Œäº†ã‚’å‰Šé™¤</button>
      <button id="clearAllBtn" class="danger">å…¨éƒ¨å‰Šé™¤</button>
    </div>

    <ul id="list"></ul>

    <div class="muted">
      â€»ãƒ‡ãƒ¼ã‚¿ã¯ã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼ˆlocalStorageï¼‰ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆç„¡æ–™ãƒ»ã‚µãƒ¼ãƒãƒ¼ä¸è¦ï¼‰
    </div>
  </div>

  <script>
    var KEY = "memo_tasks_v2";

    var tasks = load();
    var sortByDue = false;

    var input = document.getElementById("input");
    var due = document.getElementById("due");
    var list = document.getElementById("list");
    var addBtn = document.getElementById("addBtn");
    var sortBtn = document.getElementById("sortBtn");
    var clearDoneBtn = document.getElementById("clearDoneBtn");
    var clearAllBtn = document.getElementById("clearAllBtn");

    // æœŸé™ã®åˆæœŸå€¤ï¼šä»Šæ—¥ï¼ˆç©ºã§ã‚‚OKãªã‚‰ã“ã®è¡Œã‚’æ¶ˆã—ã¦OKï¼‰
    due.value = todayStr();

    addBtn.addEventListener("click", addTask);
    input.addEventListener("keydown", function(e) {
      if (e.key === "Enter") addTask();
    });

    sortBtn.addEventListener("click", function() {
      sortByDue = !sortByDue;
      sortBtn.textContent = sortByDue ? "è¿½åŠ é †ã«æˆ»ã™" : "æœŸé™ã§ä¸¦ã³æ›¿ãˆ";
      render();
    });

    clearDoneBtn.addEventListener("click", function() {
      tasks = tasks.filter(function(t) { return !t.done; });
      save(tasks);
      render();
    });

    clearAllBtn.addEventListener("click", function() {
      if (!confirm("å…¨éƒ¨æ¶ˆã—ã¾ã™ã€‚ã»ã‚“ã¨ã«OKï¼Ÿ")) return;
      tasks = [];
      save(tasks);
      render();
    });

    function addTask() {
      var text = (input.value || "").trim();
      if (!text) return;

      // type="date" ã¯ "YYYY-MM-DD" ãŒå…¥ã‚‹ï¼ˆæœªé¸æŠãªã‚‰ ""ï¼‰
      var dueStr = (due.value || "").trim();

      tasks.unshift({
        id: String(Date.now()) + "_" + Math.random().toString(16).slice(2),
        text: text,
        done: false,
        due: dueStr,        // æœŸé™ï¼ˆYYYY-MM-DD or ""ï¼‰
        createdAt: Date.now()
      });

      input.value = "";
      save(tasks);
      render();
    }

    function toggleDone(id) {
      tasks = tasks.map(function(t) {
        if (t.id === id) t.done = !t.done;
        return t;
      });
      save(tasks);
      render();
    }

    function removeTask(id) {
      tasks = tasks.filter(function(t) { return t.id !== id; });
      save(tasks);
      render();
    }

    function render() {
      list.innerHTML = "";

      if (tasks.length === 0) {
        var empty = document.createElement("li");
        empty.innerHTML = '<span class="text">ã¾ã ãƒ¡ãƒ¢ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä¸Šã®æ¬„ã‹ã‚‰è¿½åŠ ã—ã¦ã¿ã¦ï¼</span>';
        list.appendChild(empty);
        return;
      }

      var view = tasks.slice();

      if (sortByDue) {
        view.sort(function(a, b) {
          // æœŸé™ãªã—ã¯ä¸€ç•ªå¾Œã‚
          var ad = a.due || "9999-12-31";
          var bd = b.due || "9999-12-31";

          // å®Œäº†ã¯å¾Œã‚ã«å¯„ã›ãŸã„ãªã‚‰ã“ã®2è¡Œã‚’ONï¼ˆå¥½ã¿ï¼‰
          // if (a.done !== b.done) return a.done ? 1 : -1;

          if (ad < bd) return -1;
          if (ad > bd) return 1;
          return b.createdAt - a.createdAt; // åŒæœŸé™ãªã‚‰æ–°ã—ã„æ–¹ã‚’ä¸Š
        });
      }

      view.forEach(function(t) {
        var li = document.createElement("li");
        if (t.done) li.classList.add("done");

        var chk = document.createElement("input");
        chk.type = "checkbox";
        chk.checked = !!t.done;
        chk.addEventListener("change", function() { toggleDone(t.id); });

        var textWrap = document.createElement("div");
        textWrap.style.flex = "1";

        var span = document.createElement("div");
        span.className = "text";
        span.textContent = t.text;

        var meta = document.createElement("div");
        meta.className = "meta";

        if (t.due) {
          var pill = document.createElement("span");
          pill.className = "pill";
          pill.textContent = "æœŸé™: " + t.due;

          var cls = dueClass(t.due);
          if (cls) pill.classList.add(cls);

          meta.appendChild(pill);
        } else {
          meta.textContent = "æœŸé™ãªã—";
        }

        textWrap.appendChild(span);
        textWrap.appendChild(meta);

        var del = document.createElement("button");
        del.textContent = "å‰Šé™¤";
        del.addEventListener("click", function() { removeTask(t.id); });

        li.appendChild(chk);
        li.appendChild(textWrap);
        li.appendChild(del);
        list.appendChild(li);
      });
    }

    function dueClass(dueStr) {
      // dueStr: YYYY-MM-DD
      var today = todayStr();
      if (dueStr < today) return "overdue";
      if (dueStr === today) return "today";
      return "";
    }

    function todayStr() {
      var d = new Date();
      var y = d.getFullYear();
      var m = String(d.getMonth() + 1).padStart(2, "0");
      var day = String(d.getDate()).padStart(2, "0");
      return y + "-" + m + "-" + day;
    }

    function load() {
      try {
        var raw = localStorage.getItem(KEY);
        if (!raw) return [];
        var arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch (e) {
        return [];
      }
    }

    function save(arr) {
      localStorage.setItem(KEY, JSON.stringify(arr));
    }

    render();
  </script>
</body>
</html>