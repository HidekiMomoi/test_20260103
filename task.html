<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ãƒ¡ãƒ¢ / ã‚¿ã‚¹ã‚¯ï¼ˆFirebaseç‰ˆï¼‰</title>
  <style>
    :root { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; }
    body { margin: 0; background:#f7f7fb; color:#111; }
    .wrap { max-width: 820px; margin: 20px auto; padding: 0 14px 40px; }
    h1 { font-size: 30px; margin: 10px 0 14px; display:flex; align-items:center; gap:10px; }
    h1 span { font-size: 34px; }
    .card { background:#fff; border:1px solid #e6e6ef; border-radius:14px; padding:14px; box-shadow: 0 6px 18px rgba(0,0,0,.04); }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    input[type="text"]{ flex: 1 1 260px; padding:12px 12px; border:1px solid #d7d7e5; border-radius:10px; font-size:16px; }
    input[type="date"]{ padding:12px 12px; border:1px solid #d7d7e5; border-radius:10px; font-size:16px; }
    button{ padding:12px 14px; border:1px solid #d7d7e5; background:#fff; border-radius:10px; font-size:16px; cursor:pointer; }
    button.primary{ background:#2d6cdf; color:#fff; border-color:#2d6cdf; }
    button.danger{ border-color:#ff4d6d; color:#ff4d6d; }
    .tools { margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    ul{ list-style:none; padding:0; margin:14px 0 0; display:flex; flex-direction:column; gap:10px; }
    li{ background:#fff; border:1px solid #e6e6ef; border-radius:14px; padding:12px; display:flex; align-items:center; gap:10px; }
    .taskMain{ flex:1; display:flex; flex-direction:column; gap:4px; }
    .titleLine{ display:flex; align-items:center; gap:10px; }
    .titleText{ font-size:18px; }
    .done .titleText{ text-decoration: line-through; color:#777; }
    .meta{ font-size:13px; color:#666; display:flex; gap:10px; flex-wrap:wrap; }
    .badge{ font-size:12px; padding:2px 8px; border-radius:999px; background:#f0f1ff; border:1px solid #dde0ff; color:#3a42c6; }
    .badge.overdue{ background:#fff1f1; border-color:#ffd0d0; color:#c73737; }
    .badge.today{ background:#f1fff4; border-color:#c9f5d3; color:#1d7a35; }
    .footer{ font-size:13px; color:#666; margin-top:10px; }
    .small{ font-size:12px; color:#777; }
    .warn{ color:#b34b00; }
    .hidden{ display:none; }
    .spacer { flex: 1; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1><span>ğŸ“</span> ãƒ¡ãƒ¢ / ã‚¿ã‚¹ã‚¯ï¼ˆFirebaseï¼‰</h1>

    <div class="card">
      <div class="row">
        <input id="taskInput" type="text" placeholder="ä¾‹ï¼šFirebaseå‹‰å¼· 15åˆ† / è²·ã„ç‰© / ãƒ¡ãƒ¼ãƒ«è¿”ã™" />
        <input id="dueInput" type="date" />
        <button id="addBtn" class="primary">è¿½åŠ </button>
      </div>

      <div class="tools">
        <button id="deleteDoneBtn">å®Œäº†ã‚’å‰Šé™¤</button>
        <button id="deleteAllBtn" class="danger">å…¨éƒ¨å‰Šé™¤</button>
        <button id="reloadBtn">å†èª­ã¿è¾¼ã¿</button>

        <span class="spacer"></span>

        <button id="loginBtn">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button id="logoutBtn" class="hidden">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        <span id="userInfo" class="small"></span>
      </div>

      <div class="tools">
        <span id="status" class="small"></span>
      </div>

      <ul id="list"></ul>

      <div class="footer">
        â€» ãƒ‡ãƒ¼ã‚¿ã¯ <b>Firebase Firestore</b> ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆç„¡æ–™æ ã‚ã‚Šï¼‰ã€‚<br/>
        â€» æœŸé™ã¯ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰é¸æŠã§ãã¾ã™ã€‚<br/>
        â€» ãƒ­ã‚°ã‚¤ãƒ³å¾Œã¯ <b>è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã ã‘</b> è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
      </div>
    </div>
  </div>

  <script type="module">
    // =========================================
    // Firebase SDKï¼ˆCDN / moduleï¼‰
    // =========================================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

    import {
      getAuth,
      GoogleAuthProvider,
      signInWithRedirect,
      getRedirectResult,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    import {
      getFirestore,
      collection,
      addDoc,
      deleteDoc,
      doc,
      updateDoc,
      onSnapshot,
      query,
      orderBy,
      serverTimestamp,
      getDocs,
      writeBatch
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // =========================================
    // firebaseConfigï¼ˆã‚ãªãŸã®è¨­å®šï¼‰
    // =========================================
    const firebaseConfig = {
      apiKey: "AIzaSyBa1uHGYTRft3O0nGiCSTdOCnjnuWHD-R8",
      authDomain: "task-app-72b7d.firebaseapp.com",
      projectId: "task-app-72b7d",
      storageBucket: "task-app-72b7d.firebasestorage.app",
      messagingSenderId: "677238706690",
      appId: "1:677238706690:web:f8fe3af7bd3efcb9900d1b"
    };

    // =========================================
    // åˆæœŸåŒ–
    // =========================================
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // =========================================
    // DOM
    // =========================================
    const taskInput = document.getElementById("taskInput");
    const dueInput  = document.getElementById("dueInput");
    const addBtn    = document.getElementById("addBtn");

    const deleteDoneBtn = document.getElementById("deleteDoneBtn");
    const deleteAllBtn  = document.getElementById("deleteAllBtn");
    const reloadBtn     = document.getElementById("reloadBtn");

    const listEl   = document.getElementById("list");
    const statusEl = document.getElementById("status");

    const loginBtn  = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const userInfo  = document.getElementById("userInfo");

    // date input åˆæœŸå€¤ï¼ˆä»Šæ—¥ï¼‰
    dueInput.value = toDateStr(new Date());

    // =========================================
    // ä¾¿åˆ©é–¢æ•°
    // =========================================
    function toDateStr(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function badgeForDue(due) {
      if (!due) return "";
      const today = toDateStr(new Date());
      if (due < today) return `<span class="badge overdue">æœŸé™åˆ‡ã‚Œ</span>`;
      if (due === today) return `<span class="badge today">ä»Šæ—¥</span>`;
      return `<span class="badge">æœŸé™ï¼š${due}</span>`;
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function setStatus(text, isWarn=false) {
      statusEl.textContent = text;
      statusEl.className = "small" + (isWarn ? " warn" : "");
    }

    // =========================================
    // Firestore: ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
    // users/{uid}/tasks
    // =========================================
    function tasksCol(uid) {
      return collection(db, "users", uid, "tasks");
    }

    function taskDoc(uid, id) {
      return doc(db, "users", uid, "tasks", id);
    }

    // =========================================
    // Auth: ãƒ­ã‚°ã‚¤ãƒ³/ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    // =========================================
    loginBtn.addEventListener("click", async () => {
      setStatus("ãƒ­ã‚°ã‚¤ãƒ³ä¸­â€¦");
      await signInWithRedirect(auth, provider);
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    // =========================================
    // Firestore: è¿½åŠ 
    // =========================================
    async function addTask() {
      const user = auth.currentUser;
      if (!user) { setStatus("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚", true); return; }

      const title = taskInput.value.trim();
      const dueDate = dueInput.value || "";

      if (!title) {
        setStatus("ã‚¿ã‚¹ã‚¯åãŒç©ºã§ã™ã€‚", true);
        taskInput.focus();
        return;
      }

      addBtn.disabled = true;
      setStatus("è¿½åŠ ä¸­â€¦");

      try {
        await addDoc(tasksCol(user.uid), {
          title,
          dueDate,
          completed: false,
          createdAt: serverTimestamp()
        });

        taskInput.value = "";
        taskInput.focus();
        setStatus("è¿½åŠ ã—ã¾ã—ãŸï¼");
      } catch (e) {
        console.error(e);
        setStatus("è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆFirestoreãƒ«ãƒ¼ãƒ«/è¨­å®šã‚’ç¢ºèªï¼‰ã€‚", true);
      } finally {
        addBtn.disabled = false;
      }
    }

    addBtn.addEventListener("click", addTask);
    taskInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") addTask();
    });

    // =========================================
    // Firestore: æ›´æ–°ï¼ˆå®Œäº†åˆ‡æ›¿ï¼‰
    // =========================================
    async function toggleDone(uid, id, current) {
      try {
        await updateDoc(taskDoc(uid, id), { completed: !current });
      } catch (e) {
        console.error(e);
        setStatus("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", true);
      }
    }

    // =========================================
    // Firestore: å‰Šé™¤ï¼ˆ1ä»¶ï¼‰
    // =========================================
    async function deleteOne(uid, id) {
      try {
        await deleteDoc(taskDoc(uid, id));
      } catch (e) {
        console.error(e);
        setStatus("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", true);
      }
    }

    // =========================================
    // Firestore: å®Œäº†ã‚’å‰Šé™¤
    // =========================================
    async function deleteDone() {
      const user = auth.currentUser;
      if (!user) { setStatus("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚", true); return; }

      setStatus("å®Œäº†ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ä¸­â€¦");

      try {
        const snap = await getDocs(query(tasksCol(user.uid)));
        const batch = writeBatch(db);

        let count = 0;
        snap.forEach(d => {
          const data = d.data();
          if (data.completed === true) {
            batch.delete(taskDoc(user.uid, d.id));
            count++;
          }
        });

        if (count === 0) {
          setStatus("å®Œäº†ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
          return;
        }

        await batch.commit();
        setStatus(`å®Œäº†ã‚¿ã‚¹ã‚¯ã‚’ ${count} ä»¶å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
      } catch (e) {
        console.error(e);
        setStatus("å®Œäº†å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", true);
      }
    }
    deleteDoneBtn.addEventListener("click", deleteDone);

    // =========================================
    // Firestore: å…¨éƒ¨å‰Šé™¤
    // =========================================
    async function deleteAll() {
      const user = auth.currentUser;
      if (!user) { setStatus("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚", true); return; }

      if (!confirm("å…¨éƒ¨å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;

      setStatus("å…¨å‰Šé™¤ä¸­â€¦");
      try {
        const snap = await getDocs(query(tasksCol(user.uid)));
        const batch = writeBatch(db);

        let count = 0;
        snap.forEach(d => {
          batch.delete(taskDoc(user.uid, d.id));
          count++;
        });

        if (count === 0) {
          setStatus("å‰Šé™¤ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
          return;
        }

        await batch.commit();
        setStatus(`å…¨ã‚¿ã‚¹ã‚¯ã‚’ ${count} ä»¶å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
      } catch (e) {
        console.error(e);
        setStatus("å…¨å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", true);
      }
    }
    deleteAllBtn.addEventListener("click", deleteAll);

    reloadBtn.addEventListener("click", () => location.reload());

    // =========================================
    // è¡¨ç¤ºï¼ˆonSnapshotï¼‰: ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«é–‹å§‹
    // =========================================
    let unsubscribe = null;

    onAuthStateChanged(auth, async (user) => {
      // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå¾©å¸°çµæœï¼ˆå¤±æ•—ã—ã¦ã‚‚OKï¼‰
      try { await getRedirectResult(auth); } catch (_) {}

      // æ—¢å­˜ã®è³¼èª­è§£é™¤
      if (unsubscribe) {
        unsubscribe();
        unsubscribe = null;
      }

      // æœªãƒ­ã‚°ã‚¤ãƒ³
      if (!user) {
        loginBtn.classList.remove("hidden");
        logoutBtn.classList.add("hidden");
        userInfo.textContent = "";
        listEl.innerHTML = "";
        setStatus("æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã™ã€‚Googleã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚", true);
        return;
      }

      // ãƒ­ã‚°ã‚¤ãƒ³ä¸­
      loginBtn.classList.add("hidden");
      logoutBtn.classList.remove("hidden");
      userInfo.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${user.displayName ?? ""}`;

      setStatus("åŒæœŸä¸­â€¦");

      const q = query(
        tasksCol(user.uid),
        orderBy("dueDate"),
        orderBy("createdAt")
      );

      unsubscribe = onSnapshot(q, (snapshot) => {
        listEl.innerHTML = "";

        if (snapshot.empty) {
          setStatus("ã‚¿ã‚¹ã‚¯ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚");
          return;
        }

        let total = 0;
        let done  = 0;

        snapshot.forEach((d) => {
          total++;

          const data = d.data();
          const id = d.id;

          const title = escapeHtml(data.title ?? "");
          const due = data.dueDate ?? "";
          const completed = data.completed === true;
          if (completed) done++;

          const li = document.createElement("li");
          if (completed) li.classList.add("done");

          li.innerHTML = `
            <input type="checkbox" ${completed ? "checked" : ""} aria-label="å®Œäº†" />
            <div class="taskMain">
              <div class="titleLine">
                <div class="titleText">${title}</div>
              </div>
              <div class="meta">
                ${badgeForDue(due)}
                <span class="small">${completed ? "âœ… å®Œäº†" : "â¬œ æœªå®Œäº†"}</span>
              </div>
            </div>
            <button>å‰Šé™¤</button>
          `;

          li.querySelector("input").addEventListener("change", () => toggleDone(user.uid, id, completed));
          li.querySelector("button").addEventListener("click", () => deleteOne(user.uid, id));

          listEl.appendChild(li);
        });

        setStatus(`è¡¨ç¤ºä¸­ï¼š${total}ä»¶ï¼ˆå®Œäº† ${done} / æœªå®Œäº† ${total - done}ï¼‰`);
      }, (err) => {
        console.error(err);
        setStatus("èª­ã¿è¾¼ã¿ã«å¤±æ•—ï¼ˆFirestoreãƒ«ãƒ¼ãƒ«/è¨­å®šã‚’ç¢ºèªï¼‰ã€‚", true);
      });
    });
  </script>
</body>
</html>