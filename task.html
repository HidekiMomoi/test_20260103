<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ã‚¿ã‚¹ã‚¯ï¼ˆFirebaseï¼‰</title>
  <style>
    :root { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; }
    body { margin: 0; background:#f7f7fb; color:#111; }
    .wrap { max-width: 920px; margin: 18px auto; padding: 0 12px 32px; }
    h1 { font-size: 26px; margin: 8px 0 12px; display:flex; align-items:center; gap:10px; }
    h1 span { font-size: 30px; }
    .card { background:#fff; border:1px solid #e6e6ef; border-radius:14px; padding:12px; box-shadow: 0 6px 18px rgba(0,0,0,.04); }

    /* ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆUI */
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    input[type="text"]{
      flex: 1 1 260px;
      padding:10px 10px;
      border:1px solid #d7d7e5;
      border-radius:10px;
      font-size:14px;
    }
    input[type="date"]{
      padding:10px 10px;
      border:1px solid #d7d7e5;
      border-radius:10px;
      font-size:14px;
    }
    button{
      padding:10px 12px;
      border:1px solid #d7d7e5;
      background:#fff;
      border-radius:10px;
      font-size:14px;
      cursor:pointer;
      line-height:1;
    }
    button.primary{ background:#2d6cdf; color:#fff; border-color:#2d6cdf; }
    button.danger{ border-color:#ff4d6d; color:#ff4d6d; }
    button.ghost{ background:#f7f7fb; }

    .small{ font-size:12px; color:#777; }
    .warn{ color:#b34b00; }
    .hidden{ display:none; }

    /* æ¤œç´¢ã¯1è¡Œã§åã‚ã‚‹ */
    .filterRow{
      margin-top:8px;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    #searchInput{ flex: 1 1 320px; }
    .filterBtns{ display:flex; gap:8px; flex: 0 0 auto; }

    /* æŠ˜ã‚ŠãŸãŸã¿ */
    details.toolsBox{
      margin-top:10px;
      border:1px solid #e6e6ef;
      border-radius:12px;
      padding:8px 10px;
      background:#fafaff;
    }
    details.toolsBox > summary{
      cursor:pointer;
      user-select:none;
      font-size:13px;
      color:#444;
      list-style:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    details.toolsBox > summary::-webkit-details-marker{ display:none; }
    .toolsInner{
      margin-top:8px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    /* ãƒªã‚¹ãƒˆ */
    ul{ list-style:none; padding:0; margin:12px 0 0; display:flex; flex-direction:column; gap:10px; }
    li{ background:#fff; border:1px solid #e6e6ef; border-radius:14px; padding:10px; display:flex; align-items:center; gap:10px; }
    .taskMain{ flex:1; display:flex; flex-direction:column; gap:4px; min-width:0; }
    .titleText{ font-size:16px; word-break:break-word; }
    .done .titleText{ text-decoration: line-through; color:#777; }
    .meta{ font-size:12px; color:#666; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .badge{ font-size:12px; padding:2px 8px; border-radius:999px; background:#f0f1ff; border:1px solid #dde0ff; color:#3a42c6; }
    .badge.overdue{ background:#fff1f1; border-color:#ffd0d0; color:#c73737; }
    .badge.today{ background:#f1fff4; border-color:#c9f5d3; color:#1d7a35; }
    .badge.none{ background:#f7f7fb; border-color:#d7d7e5; color:#666; }
    .badge.clickable{ cursor:pointer; user-select:none; }

    .dueWrap { display:flex; align-items:center; gap:8px; }
    .inlineDate {
      display:flex; gap:8px; align-items:center;
      padding:4px 6px; border:1px solid #d7d7e5; border-radius:10px; background:#fff;
    }
    .inlineDate input[type="date"]{ padding:6px 6px; font-size:13px; border-radius:8px; }
    .inlineDate button{ padding:7px 9px; font-size:13px; }

    .btnCol{ display:flex; gap:8px; align-items:center; }
    .btnCol button{ padding:8px 10px; font-size:13px; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1><span>âœ…</span> ã‚¿ã‚¹ã‚¯ï¼ˆFirebaseï¼‰</h1>

    <div class="card">
      <!-- è¿½åŠ /æ›´æ–° -->
      <div class="row">
        <input id="taskInput" type="text" placeholder="ä¾‹ï¼šFirebaseå‹‰å¼· 15åˆ† / è²·ã„ç‰© / ãƒ¡ãƒ¼ãƒ«è¿”ã™" />
        <input id="dueInput" type="date" />
        <button id="addBtn" class="primary">è¿½åŠ </button>
        <button id="cancelEditBtn" class="hidden">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button id="clearInputBtn" class="ghost">ã‚¯ãƒªã‚¢</button>
      </div>

      <!-- æ¤œç´¢ -->
      <div class="filterRow">
        <input id="searchInput" type="text" placeholder="æ¤œç´¢ï¼šè²·ã„ç‰© / 2026-01-10 / å®Œäº† / ä»Šæ—¥ / æœŸé™åˆ‡ã‚Œ / æœªå®Œäº†" />
        <div class="filterBtns">
          <button id="clearSearchBtn" class="ghost">æ¤œç´¢ã‚¯ãƒªã‚¢</button>
          <button id="reloadBtn">å†èª­è¾¼</button>
        </div>
      </div>

      <!-- ãƒ„ãƒ¼ãƒ«ã¯æŠ˜ã‚ŠãŸãŸã¿ï¼ˆæ™®æ®µã¯é–‰ã˜ã‚‹ï¼‰ -->
      <details class="toolsBox">
        <summary>
          <span>âš™ï¸ ãƒ„ãƒ¼ãƒ« / ãƒ­ã‚°ã‚¤ãƒ³</span>
          <span id="status" class="small"></span>
        </summary>
        <div class="toolsInner">
          <button id="deleteDoneBtn">å®Œäº†å‰Šé™¤</button>
          <button id="deleteAllBtn" class="danger">å…¨å‰Šé™¤</button>

          <button id="loginBtn">Googleãƒ­ã‚°ã‚¤ãƒ³</button>
          <button id="logoutBtn" class="hidden">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
          <span id="userInfo" class="small"></span>
        </div>
        <div class="small" style="margin-top:6px;">
          ğŸ’¡ æœŸé™ãƒãƒƒã‚¸ã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ dateã€‚å¤‰æ›´ã—ãŸç¬é–“ã«è‡ªå‹•ä¿å­˜ã€‚Esc / ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¤–ã‚Œã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€‚
        </div>
      </details>

      <ul id="list"></ul>
    </div>
  </div>

  <script type="module">
    import { firebaseConfig } from "./config.js";

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
      getFirestore,
      collection, addDoc, deleteDoc, doc, updateDoc,
      onSnapshot, query, orderBy, serverTimestamp,
      getDocs, writeBatch
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const taskInput = document.getElementById("taskInput");
    const dueInput  = document.getElementById("dueInput");
    const addBtn    = document.getElementById("addBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    const clearInputBtn = document.getElementById("clearInputBtn");

    const searchInput = document.getElementById("searchInput");
    const clearSearchBtn = document.getElementById("clearSearchBtn");

    const deleteDoneBtn = document.getElementById("deleteDoneBtn");
    const deleteAllBtn  = document.getElementById("deleteAllBtn");
    const reloadBtn     = document.getElementById("reloadBtn");

    const listEl   = document.getElementById("list");
    const statusEl = document.getElementById("status");

    const loginBtn  = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const userInfo  = document.getElementById("userInfo");

    let currentUid = null;
    let unsubscribe = null;

    let editingId = null;
    let allTasks = [];
    let searchKey = "";

    dueInput.value = toDateStr(new Date());

    function setStatus(text, isWarn=false) {
      statusEl.textContent = text;
      statusEl.className = "small" + (isWarn ? " warn" : "");
    }
    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
    function toDateStr(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }
    function tasksCol(uid) { return collection(db, "users", uid, "tasks"); }
    function stopListen() { if (unsubscribe) { unsubscribe(); unsubscribe = null; } }
    function needLogin() { setStatus("æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã™ã€‚âš™ï¸ã‹ã‚‰Googleãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­", true); }

    function dueLabel(due) {
      if (!due) return "æœŸé™ãªã—";
      const today = toDateStr(new Date());
      if (due < today) return "æœŸé™åˆ‡ã‚Œ";
      if (due === today) return "ä»Šæ—¥";
      return `æœŸé™ ${due}`;
    }
    function badgeForDue(due) {
      if (!due) return `<span class="badge none clickable" data-badge="1">æœŸé™ãªã—</span>`;
      const today = toDateStr(new Date());
      if (due < today) return `<span class="badge overdue clickable" data-badge="1">æœŸé™åˆ‡ã‚Œ</span>`;
      if (due === today) return `<span class="badge today clickable" data-badge="1">ä»Šæ—¥</span>`;
      return `<span class="badge clickable" data-badge="1">æœŸé™ï¼š${due}</span>`;
    }

    function buildSearchHaystack(t) {
      const title = (t.title ?? "");
      const due = (t.dueDate ?? "");
      const state = t.completed ? "å®Œäº† done" : "æœªå®Œäº† todo";
      const dueText = dueLabel(due);
      return `${title}\n${due}\n${state}\n${dueText}`.toLowerCase();
    }

    function sortTasksForUI(arr) {
      return arr.slice().sort((a, b) => {
        const ad = a.dueDate || "";
        const bd = b.dueDate || "";
        const aHas = !!ad;
        const bHas = !!bd;
        if (aHas && !bHas) return -1;
        if (!aHas && bHas) return 1;
        if (!aHas && !bHas) return 0;
        if (ad < bd) return -1;
        if (ad > bd) return 1;
        return 0;
      });
    }

    function applyFilterAndRender() {
      const key = (searchKey || "").trim().toLowerCase();
      const base = sortTasksForUI(allTasks);
      const filtered = !key ? base : base.filter(t => buildSearchHaystack(t).includes(key));
      renderList(filtered);
    }

    function clearInputs() {
      taskInput.value = "";
      dueInput.value = toDateStr(new Date());
      exitEditMode(false);
      taskInput.focus();
      setStatus("å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚");
    }

    function enterEditMode(task) {
      editingId = task.id;
      taskInput.value = task.title ?? "";
      dueInput.value = task.dueDate ?? "";
      addBtn.textContent = "æ›´æ–°";
      cancelEditBtn.classList.remove("hidden");
      setStatus("ç·¨é›†ä¸­ï¼šæ›´æ–°ã‚’æŠ¼ã™ã¨ä¿å­˜ã—ã¾ã™ã€‚");
      taskInput.focus();
    }

    function exitEditMode(showStatus=true) {
      editingId = null;
      addBtn.textContent = "è¿½åŠ ";
      cancelEditBtn.classList.add("hidden");
      if (showStatus) setStatus("ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚");
    }

    loginBtn.addEventListener("click", async () => {
      try { setStatus("ãƒ­ã‚°ã‚¤ãƒ³ä¸­â€¦"); await signInWithPopup(auth, provider); }
      catch (e) { console.error(e); setStatus(`ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ${e?.code || e?.message}`, true); }
    });
    logoutBtn.addEventListener("click", async () => { await signOut(auth); });

    searchInput.addEventListener("input", () => { searchKey = searchInput.value ?? ""; applyFilterAndRender(); });
    clearSearchBtn.addEventListener("click", () => {
      searchInput.value = ""; searchKey = ""; applyFilterAndRender(); setStatus("æ¤œç´¢ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚");
    });

    async function upsertTask(uid) {
      const title = taskInput.value.trim();
      const dueDate = (dueInput.value || "").trim();

      if (!title) { setStatus("ã‚¿ã‚¹ã‚¯åãŒç©ºã§ã™ã€‚", true); taskInput.focus(); return; }

      addBtn.disabled = true;
      setStatus(editingId ? "æ›´æ–°ä¸­â€¦" : "è¿½åŠ ä¸­â€¦");

      try {
        if (!editingId) {
          await addDoc(tasksCol(uid), { title, dueDate, completed:false, createdAt: serverTimestamp() });
          taskInput.value = ""; taskInput.focus();
          setStatus("è¿½åŠ ã—ã¾ã—ãŸï¼");
        } else {
          await updateDoc(doc(db, "users", uid, "tasks", editingId), { title, dueDate, updatedAt: serverTimestamp() });
          clearInputs();
          setStatus("æ›´æ–°ã—ã¾ã—ãŸï¼");
        }
      } catch (e) {
        console.error(e);
        setStatus(`${editingId ? "æ›´æ–°" : "è¿½åŠ "}ã«å¤±æ•—: ${e?.code || e?.message}`, true);
      } finally {
        addBtn.disabled = false;
      }
    }

    async function toggleDone(uid, id, current) {
      try { await updateDoc(doc(db, "users", uid, "tasks", id), { completed: !current }); }
      catch (e) { console.error(e); setStatus(`æ›´æ–°ã«å¤±æ•—: ${e?.code || e?.message}`, true); }
    }

    async function deleteOne(uid, id) {
      try { await deleteDoc(doc(db, "users", uid, "tasks", id)); if (editingId === id) exitEditMode(false); }
      catch (e) { console.error(e); setStatus(`å‰Šé™¤ã«å¤±æ•—: ${e?.code || e?.message}`, true); }
    }

    async function updateDueDateInline(uid, id, newDueDate) {
      try {
        await updateDoc(doc(db, "users", uid, "tasks", id), { dueDate: newDueDate, updatedAt: serverTimestamp() });
        setStatus("æœŸé™ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼");
      } catch (e) {
        console.error(e);
        setStatus(`æœŸé™æ›´æ–°ã«å¤±æ•—: ${e?.code || e?.message}`, true);
      }
    }

    async function deleteDone(uid) {
      setStatus("å®Œäº†ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ä¸­â€¦");
      try {
        const snap = await getDocs(query(tasksCol(uid)));
        const batch = writeBatch(db);
        let count = 0;
        snap.forEach(d => { if (d.data().completed === true) { batch.delete(doc(db, "users", uid, "tasks", d.id)); count++; } });
        if (count === 0) { setStatus("å®Œäº†ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"); return; }
        await batch.commit();
        setStatus(`å®Œäº†ã‚¿ã‚¹ã‚¯ã‚’ ${count} ä»¶å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
      } catch (e) {
        console.error(e);
        setStatus(`å®Œäº†å‰Šé™¤ã«å¤±æ•—: ${e?.code || e?.message}`, true);
      }
    }

    async function deleteAll(uid) {
      if (!confirm("å…¨éƒ¨å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
      setStatus("å…¨å‰Šé™¤ä¸­â€¦");
      try {
        const snap = await getDocs(query(tasksCol(uid)));
        const batch = writeBatch(db);
        let count = 0;
        snap.forEach(d => { batch.delete(doc(db, "users", uid, "tasks", d.id)); count++; });
        if (count === 0) { setStatus("å‰Šé™¤ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"); return; }
        await batch.commit();
        exitEditMode(false);
        clearInputs();
        setStatus(`å…¨ã‚¿ã‚¹ã‚¯ã‚’ ${count} ä»¶å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
      } catch (e) {
        console.error(e);
        setStatus(`å…¨å‰Šé™¤ã«å¤±æ•—: ${e?.code || e?.message}`, true);
      }
    }

    function renderList(tasks) {
      listEl.innerHTML = "";
      if (!currentUid) { needLogin(); return; }

      if (tasks.length === 0) {
        setStatus(allTasks.length === 0 ? "ã‚¿ã‚¹ã‚¯ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚" : "è©²å½“ãªã—ï¼ˆæ¤œç´¢æ¡ä»¶ã‚’è¦‹ç›´ã—ã¦ã­ï¼‰");
        return;
      }

      let doneCount = 0;

      tasks.forEach((t) => {
        if (t.completed) doneCount++;

        const id = t.id;
        const title = escapeHtml(t.title ?? "");
        const due = t.dueDate ?? "";
        const completed = t.completed === true;

        const li = document.createElement("li");
        if (completed) li.classList.add("done");

        li.innerHTML = `
          <input type="checkbox" ${completed ? "checked" : ""} aria-label="å®Œäº†" />
          <div class="taskMain">
            <div class="titleText">${title}</div>
            <div class="meta">
              <span class="dueWrap">${badgeForDue(due)}</span>
              <span class="small">${completed ? "âœ… å®Œäº†" : "â¬œ æœªå®Œäº†"}</span>
            </div>
          </div>
          <div class="btnCol">
            <button data-edit="1">ç·¨é›†</button>
            <button data-del="1">å‰Šé™¤</button>
          </div>
        `;

        li.querySelector("input").addEventListener("change", () => toggleDone(currentUid, id, completed));
        li.querySelector("[data-del]").addEventListener("click", () => deleteOne(currentUid, id));
        li.querySelector("[data-edit]").addEventListener("click", () => enterEditMode(t));

        const badge = li.querySelector("[data-badge]");
        const dueWrap = li.querySelector(".dueWrap");

        if (badge) {
          badge.addEventListener("click", () => {
            if (dueWrap.querySelector("input[type=date]")) return;

            const before = due || "";
            const initial = before || toDateStr(new Date());

            const box = document.createElement("div");
            box.className = "inlineDate";
            box.innerHTML = `
              <input type="date" value="${escapeHtml(initial)}" />
              <button data-none="1" class="ghost">ãªã—</button>
            `;

            const dateEl = box.querySelector("input");
            const noneBtn = box.querySelector("[data-none]");

            // å¤‰æ›´ã—ãŸç¬é–“ã«è‡ªå‹•ä¿å­˜
            dateEl.addEventListener("change", async () => {
              const newDue = (dateEl.value || "").trim();
              await updateDueDateInline(currentUid, id, newDue);
            });

            noneBtn.addEventListener("click", async () => {
              await updateDueDateInline(currentUid, id, "");
            });

            const cancelToBadge = () => { applyFilterAndRender(); };

            dateEl.addEventListener("keydown", (e) => { if (e.key === "Escape") cancelToBadge(); });
            dateEl.addEventListener("blur", () => setTimeout(cancelToBadge, 120));

            dueWrap.innerHTML = "";
            dueWrap.appendChild(box);

            dateEl.focus();
            try { dateEl.showPicker?.(); } catch(e) {}
          });
        }

        listEl.appendChild(li);
      });

      setStatus(`è¡¨ç¤ºä¸­ï¼š${tasks.length}ä»¶ï¼ˆå…¨ ${allTasks.length}ä»¶ / å®Œäº† ${doneCount}ï¼‰`);
    }

    function startListen(uid) {
      stopListen();

      const q = query(tasksCol(uid), orderBy("createdAt"));

      setStatus("åŒæœŸä¸­â€¦");
      unsubscribe = onSnapshot(q, (snapshot) => {
        allTasks = snapshot.docs.map(d => {
          const data = d.data() || {};
          return {
            id: d.id,
            title: data.title ?? "",
            dueDate: (data.dueDate ?? "").toString(),
            completed: data.completed === true
          };
        });
        applyFilterAndRender();
      }, (err) => {
        console.error(err);
        setStatus(`èª­ã¿è¾¼ã¿ã«å¤±æ•—: ${err?.code || err?.message}`, true);
      });
    }

    addBtn.addEventListener("click", () => { if (!currentUid) return needLogin(); upsertTask(currentUid); });
    taskInput.addEventListener("keydown", (e) => { if (e.key === "Enter") { if (!currentUid) return needLogin(); upsertTask(currentUid); } });
    cancelEditBtn.addEventListener("click", () => exitEditMode(true));
    clearInputBtn.addEventListener("click", clearInputs);

    deleteDoneBtn.addEventListener("click", () => { if (!currentUid) return needLogin(); deleteDone(currentUid); });
    deleteAllBtn.addEventListener("click", () => { if (!currentUid) return needLogin(); deleteAll(currentUid); });

    reloadBtn.addEventListener("click", () => location.reload());

    onAuthStateChanged(auth, (user) => {
      stopListen();
      listEl.innerHTML = "";
      exitEditMode(false);

      if (!user) {
        currentUid = null;
        loginBtn.classList.remove("hidden");
        logoutBtn.classList.add("hidden");
        userInfo.textContent = "";
        needLogin();
        return;
      }

      currentUid = user.uid;
      loginBtn.classList.add("hidden");
      logoutBtn.classList.remove("hidden");
      userInfo.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${user.displayName ?? ""}`;

      startListen(user.uid);
    });
  </script>
</body>
</html>
