<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãƒ¡ãƒ¢ / ã‚¿ã‚¹ã‚¯ï¼ˆç·¨é›†ï¼†å®Œäº†ä¸‹ã¸ï¼‰</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin: 24px; }
    .wrap { max-width: 780px; margin: 0 auto; }
    h1 { margin: 0 0 12px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    input[type="text"] { flex: 1; min-width: 220px; padding: 10px; font-size: 16px; }
    input[type="date"] { padding: 10px; font-size: 16px; }
    button { padding: 10px 12px; font-size: 14px; cursor: pointer; }
    ul { list-style: none; padding: 0; margin: 16px 0 0; }
    li { display: flex; align-items: flex-start; gap: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 12px; margin-bottom: 8px; }
    li.done { opacity: .85; }
    li.done .titleEdit { text-decoration: line-through; opacity: .7; }
    .col { flex: 1; display: flex; flex-direction: column; gap: 8px; }
    .titleEdit { width: 100%; padding: 8px 10px; font-size: 16px; }
    .meta { font-size: 12px; color: #666; display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid #ddd; }
    .overdue { border-color: #f55; color: #c00; }
    .today { border-color: #fa0; color: #a60; }
    .dueEdit { font-size: 14px; padding: 6px 8px; }
    .smallBtn { padding: 6px 10px; font-size: 12px; }
    .muted { color: #666; font-size: 12px; margin-top: 10px; }
    .danger { border: 1px solid #f0b; }
    .spacer { height: 4px; }
    .right { display:flex; gap:8px; align-items:center; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ“ ãƒ¡ãƒ¢ / ã‚¿ã‚¹ã‚¯</h1>

    <div class="row">
      <input id="input" type="text" placeholder="ä¾‹ï¼šFirebaseå‹‰å¼· 15åˆ† / è²·ã„ç‰© / ãƒ¡ãƒ¼ãƒ«è¿”ã™" />
      <input id="due" type="date" />
      <button id="addBtn">è¿½åŠ </button>
    </div>

    <div class="spacer"></div>

    <div class="row">
      <button id="sortBtn">æœŸé™ã§ä¸¦ã³æ›¿ãˆ</button>
      <button id="clearDoneBtn">å®Œäº†ã‚’å‰Šé™¤</button>
      <button id="clearAllBtn" class="danger">å…¨éƒ¨å‰Šé™¤</button>
    </div>

    <ul id="list"></ul>

    <div class="muted">
      â€»ãƒ‡ãƒ¼ã‚¿ã¯ã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼ˆlocalStorageï¼‰ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆç„¡æ–™ãƒ»ã‚µãƒ¼ãƒãƒ¼ä¸è¦ï¼‰
    </div>
  </div>

  <script>
    var KEY = "memo_tasks_v4";

    var tasks = load();
    var sortByDue = false;

    var input = document.getElementById("input");
    var due = document.getElementById("due");
    var list = document.getElementById("list");
    var addBtn = document.getElementById("addBtn");
    var sortBtn = document.getElementById("sortBtn");
    var clearDoneBtn = document.getElementById("clearDoneBtn");
    var clearAllBtn = document.getElementById("clearAllBtn");

    // è¿½åŠ æ™‚ã®æœŸé™ï¼šç©ºæ¬„ï¼ˆå¥½ã¿ã§ todayStr() ã§ã‚‚OKï¼‰
    due.value = "";

    addBtn.addEventListener("click", addTask);
    input.addEventListener("keydown", function(e) {
      if (e.key === "Enter") addTask();
    });

    sortBtn.addEventListener("click", function() {
      sortByDue = !sortByDue;
      sortBtn.textContent = sortByDue ? "è¿½åŠ é †ã«æˆ»ã™" : "æœŸé™ã§ä¸¦ã³æ›¿ãˆ";
      render();
    });

    clearDoneBtn.addEventListener("click", function() {
      tasks = tasks.filter(function(t) { return !t.done; });
      save(tasks);
      render();
    });

    clearAllBtn.addEventListener("click", function() {
      if (!confirm("å…¨éƒ¨æ¶ˆã—ã¾ã™ã€‚ã»ã‚“ã¨ã«OKï¼Ÿ")) return;
      tasks = [];
      save(tasks);
      render();
    });

    function addTask() {
      var text = (input.value || "").trim();
      if (!text) return;

      var dueStr = (due.value || "").trim();

      tasks.unshift({
        id: String(Date.now()) + "_" + Math.random().toString(16).slice(2),
        text: text,
        done: false,
        due: dueStr,
        createdAt: Date.now(),
        doneAt: null
      });

      input.value = "";
      save(tasks);
      render();
    }

    // âœ… 2: å®Œäº†ã«ã—ãŸã‚‰ä¸‹ã¸ï¼ˆdoneAtã‚’ä½¿ã£ã¦é †åºã‚’å®‰å®šã•ã›ã‚‹ï¼‰
    function toggleDone(id) {
      var now = Date.now();
      tasks = tasks.map(function(t) {
        if (t.id === id) {
          t.done = !t.done;
          t.doneAt = t.done ? now : null;
        }
        return t;
      });
      save(tasks);
      render();
    }

    // âœ… 3: ã‚¿ã‚¹ã‚¯åã‚’ç·¨é›†ï¼ˆå³ä¿å­˜ï¼‰
    function setText(id, newText) {
      tasks = tasks.map(function(t) {
        if (t.id === id) t.text = (newText || "").trim();
        return t;
      });
      save(tasks);
      // renderã¯ã—ãªã„ï¼ˆç·¨é›†ä¸­ã«ã‚«ãƒ¼ã‚½ãƒ«ãŒé£›ã¶ã®ã‚’é¿ã‘ã‚‹ï¼‰
    }

    // æœŸé™ã‚’æ›´æ–°ï¼ˆå³ä¿å­˜ï¼‰
    function setDue(id, dueStr) {
      tasks = tasks.map(function(t) {
        if (t.id === id) t.due = (dueStr || "").trim();
        return t;
      });
      save(tasks);
      render();
    }

    function removeTask(id) {
      tasks = tasks.filter(function(t) { return t.id !== id; });
      save(tasks);
      render();
    }

    function render() {
      list.innerHTML = "";

      if (tasks.length === 0) {
        var empty = document.createElement("li");
        empty.innerHTML = '<div class="col">ã¾ã ãƒ¡ãƒ¢ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä¸Šã®æ¬„ã‹ã‚‰è¿½åŠ ã—ã¦ã¿ã¦ï¼</div>';
        list.appendChild(empty);
        return;
      }

      // åŸºæœ¬ã®ä¸¦ã³ï¼šæœªå®Œäº† â†’ å®Œäº†ï¼ˆå®Œäº†ã¯ doneAt æ–°ã—ã„é †ã§ä¸‹ã«å¯„ã›ã¤ã¤æ•´åˆ—ï¼‰
      var view = tasks.slice();
      view.sort(function(a, b) {
        if (a.done !== b.done) return a.done ? 1 : -1; // å®Œäº†ã¯ä¸‹
        if (a.done && b.done) {
          // å®Œäº†å†…ï¼šæ–°ã—ãå®Œäº†ã—ãŸã‚‚ã®ã‚’ä¸Šã«ï¼ˆå¥½ã¿ã§é€†ã«ã‚‚ã§ãã‚‹ï¼‰
          return (b.doneAt || 0) - (a.doneAt || 0);
        }
        // æœªå®Œäº†å†…ï¼šè¿½åŠ é †ï¼ˆæ–°ã—ã„ã®ãŒä¸Šï¼‰
        return b.createdAt - a.createdAt;
      });

      // æœŸé™ã§ä¸¦ã³æ›¿ãˆONãªã‚‰ï¼šæœªå®Œäº†ã®ä¸­ã ã‘æœŸé™ã‚½ãƒ¼ãƒˆï¼ˆå®Œäº†ã¯å¸¸ã«ä¸‹ï¼‰
      if (sortByDue) {
        var undone = view.filter(function(t){ return !t.done; });
        var done = view.filter(function(t){ return t.done; });

        undone.sort(function(a, b) {
          var ad = a.due || "9999-12-31";
          var bd = b.due || "9999-12-31";
          if (ad < bd) return -1;
          if (ad > bd) return 1;
          return b.createdAt - a.createdAt;
        });

        view = undone.concat(done);
      }

      view.forEach(function(t) {
        var li = document.createElement("li");
        if (t.done) li.classList.add("done");

        var chk = document.createElement("input");
        chk.type = "checkbox";
        chk.checked = !!t.done;
        chk.addEventListener("change", function() { toggleDone(t.id); });

        var col = document.createElement("div");
        col.className = "col";

        // ã‚¿ã‚¹ã‚¯åç·¨é›†æ¬„
        var titleEdit = document.createElement("input");
        titleEdit.type = "text";
        titleEdit.className = "titleEdit";
        titleEdit.value = t.text || "";
        titleEdit.placeholder = "ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›â€¦";

        // å…¥åŠ›ä¸­ã«ä¿å­˜ï¼ˆå³åæ˜ ï¼‰
        titleEdit.addEventListener("input", function() {
          setText(t.id, titleEdit.value);
        });
        // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¤–ã‚ŒãŸã‚‰å†æç”»ã—ã¦è¡¨ç¤ºæ›´æ–°ï¼ˆtrimåæ˜ ãªã©ï¼‰
        titleEdit.addEventListener("blur", function() {
          // ç©ºãªã‚‰è‡ªå‹•å‰Šé™¤ã—ãŸã„ãªã‚‰ã“ã“ã§å‰Šé™¤ã‚‚å¯ã€‚ä»Šã¯æ®‹ã™ã€‚
          save(tasks);
          render();
        });

        // ãƒ¡ã‚¿æƒ…å ±ï¼ˆæœŸé™è¡¨ç¤ºï¼‹ç·¨é›†ï¼‰
        var meta = document.createElement("div");
        meta.className = "meta";

        var pill = document.createElement("span");
        pill.className = "pill";
        if (t.due) {
          pill.textContent = "æœŸé™: " + t.due;
          var cls = dueClass(t.due);
          if (cls) pill.classList.add(cls);
        } else {
          pill.textContent = "æœŸé™ãªã—";
        }

        var dueEdit = document.createElement("input");
        dueEdit.type = "date";
        dueEdit.className = "dueEdit";
        dueEdit.value = t.due || "";
        dueEdit.addEventListener("change", function() {
          setDue(t.id, dueEdit.value);
        });

        var clearDueBtn = document.createElement("button");
        clearDueBtn.className = "smallBtn";
        clearDueBtn.textContent = "æœŸé™ã‚¯ãƒªã‚¢";
        clearDueBtn.addEventListener("click", function() {
          setDue(t.id, "");
        });

        meta.appendChild(pill);
        meta.appendChild(dueEdit);
        meta.appendChild(clearDueBtn);

        col.appendChild(titleEdit);
        col.appendChild(meta);

        var del = document.createElement("button");
        del.textContent = "å‰Šé™¤";
        del.addEventListener("click", function() { removeTask(t.id); });

        li.appendChild(chk);
        li.appendChild(col);
        li.appendChild(del);
        list.appendChild(li);
      });
    }

    function dueClass(dueStr) {
      var today = todayStr();
      if (dueStr < today) return "overdue";
      if (dueStr === today) return "today";
      return "";
    }

    function todayStr() {
      var d = new Date();
      var y = d.getFullYear();
      var m = String(d.getMonth() + 1).padStart(2, "0");
      var day = String(d.getDate()).padStart(2, "0");
      return y + "-" + m + "-" + day;
    }

    function load() {
      try {
        var raw = localStorage.getItem(KEY);
        if (!raw) return [];
        var arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch (e) {
        return [];
      }
    }

    function save(arr) {
      localStorage.setItem(KEY, JSON.stringify(arr));
    }

    render();
  </script>
</body>
</html>