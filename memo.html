<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ãƒ¡ãƒ¢ï¼ˆFirebaseï¼‰</title>
  <style>
    :root { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; }
    body { margin:0; background:#f7f7fb; color:#111; }
    .wrap { max-width: 920px; margin: 18px auto; padding: 0 14px 40px; }
    h1 { font-size: 28px; margin: 10px 0 14px; display:flex; align-items:center; gap:10px; }
    h1 span { font-size: 32px; }
    .card { background:#fff; border:1px solid #e6e6ef; border-radius:14px; padding:14px; box-shadow: 0 6px 18px rgba(0,0,0,.04); }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input[type="text"]{ flex: 1 1 260px; padding:12px 12px; border:1px solid #d7d7e5; border-radius:10px; font-size:16px; }
    textarea{ flex: 1 1 520px; min-height: 90px; resize: vertical; padding:12px 12px; border:1px solid #d7d7e5; border-radius:10px; font-size:16px; }
    button{ padding:12px 14px; border:1px solid #d7d7e5; background:#fff; border-radius:10px; font-size:16px; cursor:pointer; }
    button.primary{ background:#2d6cdf; color:#fff; border-color:#2d6cdf; }
    button.danger{ border-color:#ff4d6d; color:#ff4d6d; }
    .tools { margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .small{ font-size:12px; color:#777; }
    .warn{ color:#b34b00; }
    .hidden{ display:none; }

    .list { margin-top:14px; display:flex; flex-direction:column; gap:10px; }
    .memo {
      background:#fff; border:1px solid #e6e6ef; border-radius:14px; padding:12px;
      display:flex; gap:10px; align-items:flex-start;
    }
    .memoMain { flex:1; display:flex; flex-direction:column; gap:6px; }
    .memoTitle { font-weight:700; font-size:16px; }
    .memoBody { white-space:pre-wrap; color:#222; }
    .meta { display:flex; gap:10px; flex-wrap:wrap; color:#666; font-size:12px; }
    .badge { font-size:12px; padding:2px 8px; border-radius:999px; background:#f0f1ff; border:1px solid #dde0ff; color:#3a42c6; }
    .footer { font-size:13px; color:#666; margin-top:10px; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1><span>ğŸ—’ï¸</span> ãƒ¡ãƒ¢ï¼ˆFirebaseï¼‰</h1>

    <div class="card">
      <!-- å…¥åŠ› -->
      <div class="row">
        <input id="titleInput" type="text" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä¾‹ï¼šè²·ã„ç‰©ã€ã‚¢ã‚¤ãƒ‡ã‚¢ã€èª¿ã¹ãŸã“ã¨ï¼‰" />
      </div>
      <div class="row" style="margin-top:10px;">
        <textarea id="bodyInput" placeholder="æœ¬æ–‡ï¼ˆãƒ¡ãƒ¢å†…å®¹ï¼‰"></textarea>
        <button id="addBtn" class="primary">è¿½åŠ </button>
      </div>

      <!-- æ¤œç´¢ï¼‹æ“ä½œ -->
      <div class="tools">
        <input id="searchInput" type="text" placeholder="æ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãƒ»æœ¬æ–‡ï¼‰" />
        <button id="reloadBtn">å†èª­ã¿è¾¼ã¿</button>
        <button id="deleteAllBtn" class="danger hidden">å…¨å‰Šé™¤</button>
        <span id="status" class="small"></span>
      </div>

      <!-- ãƒ­ã‚°ã‚¤ãƒ³ -->
      <div class="tools">
        <button id="loginBtn">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button id="logoutBtn" class="hidden">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        <span id="userInfo" class="small"></span>
      </div>

      <!-- ä¸€è¦§ -->
      <div id="list" class="list"></div>

      <div class="footer">
        â€» ãƒ‡ãƒ¼ã‚¿ã¯ <b>Firebase Firestore</b> ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆè‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ï¼‰ã€‚<br/>
        â€» æ¤œç´¢ã¯ç”»é¢ä¸Šã®çµã‚Šè¾¼ã¿ï¼ˆé«˜é€Ÿï¼‰ã§ã™ã€‚
      </div>
    </div>
  </div>

  <script type="module">
    // ===== Firebase SDKï¼ˆCDNï¼‰=====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithRedirect, getRedirectResult,
      onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, deleteDoc, doc,
      onSnapshot, query, orderBy, serverTimestamp, getDocs, writeBatch
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ===== configå¤–ã ã—ï¼ˆåŒãƒ•ã‚©ãƒ«ãƒ€ã« firebase-config.js ã‚’ç½®ãï¼‰=====
    import { firebaseConfig } from "./firebase-config.js";

    // ===== åˆæœŸåŒ– =====
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // ===== DOM =====
    const titleInput = document.getElementById("titleInput");
    const bodyInput = document.getElementById("bodyInput");
    const addBtn = document.getElementById("addBtn");
    const searchInput = document.getElementById("searchInput");
    const reloadBtn = document.getElementById("reloadBtn");
    const deleteAllBtn = document.getElementById("deleteAllBtn");
    const listEl = document.getElementById("list");
    const statusEl = document.getElementById("status");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const userInfo = document.getElementById("userInfo");

    // ===== çŠ¶æ…‹ =====
    let currentUser = null;
    let unsubscribe = null;
    let cache = []; // æ¤œç´¢ç”¨ã®æ‰‹å…ƒã‚­ãƒ£ãƒƒã‚·ãƒ¥

    function setStatus(text, isWarn=false) {
      statusEl.textContent = text;
      statusEl.className = "small" + (isWarn ? " warn" : "");
    }
    function escapeHtml(s) {
      return (s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
    function fmtDate(ts) {
      try {
        const d = ts?.toDate ? ts.toDate() : null;
        if (!d) return "";
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,"0");
        const day = String(d.getDate()).padStart(2,"0");
        const hh = String(d.getHours()).padStart(2,"0");
        const mm = String(d.getMinutes()).padStart(2,"0");
        return `${y}/${m}/${day} ${hh}:${mm}`;
      } catch { return ""; }
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼šusers/{uid}/memos
    function memosCol(uid) {
      return collection(db, "users", uid, "memos");
    }

    // ===== æç”»ï¼ˆæ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨ï¼‰=====
    function render() {
      const q = (searchInput.value || "").trim().toLowerCase();
      const items = q
        ? cache.filter(x =>
            (x.title||"").toLowerCase().includes(q) ||
            (x.body||"").toLowerCase().includes(q)
          )
        : cache;

      listEl.innerHTML = "";
      if (items.length === 0) {
        setStatus(q ? "è©²å½“ãªã—ï¼ˆæ¤œç´¢æ¡ä»¶ï¼‰" : "ãƒ¡ãƒ¢ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚");
        return;
      }

      setStatus(`è¡¨ç¤ºä¸­ï¼š${items.length}ä»¶ï¼ˆå…¨ ${cache.length}ä»¶ï¼‰`);

      for (const m of items) {
        const el = document.createElement("div");
        el.className = "memo";
        const title = escapeHtml(m.title || "(ç„¡é¡Œ)");
        const body = escapeHtml(m.body || "");
        const created = fmtDate(m.createdAt);

        el.innerHTML = `
          <div class="memoMain">
            <div class="memoTitle">${title}</div>
            <div class="memoBody">${body}</div>
            <div class="meta">
              ${created ? `<span class="badge">ä½œæˆï¼š${created}</span>` : ""}
            </div>
          </div>
          <button class="danger">å‰Šé™¤</button>
        `;

        el.querySelector("button").addEventListener("click", async () => {
          if (!currentUser) return;
          try {
            await deleteDoc(doc(db, "users", currentUser.uid, "memos", m.id));
          } catch (e) {
            console.error(e);
            setStatus("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒ«ãƒ¼ãƒ«/æ¨©é™ï¼‰ã€‚", true);
          }
        });

        listEl.appendChild(el);
      }
    }

    searchInput.addEventListener("input", render);

    // ===== è¿½åŠ  =====
    async function addMemo() {
      if (!currentUser) {
        setStatus("æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã™ã€‚Googleã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚", true);
        return;
      }
      const title = titleInput.value.trim();
      const body = bodyInput.value.trim();

      if (!title && !body) {
        setStatus("ã‚¿ã‚¤ãƒˆãƒ«ã‹æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", true);
        return;
      }

      addBtn.disabled = true;
      setStatus("è¿½åŠ ä¸­â€¦");

      try {
        await addDoc(memosCol(currentUser.uid), {
          title: title || "(ç„¡é¡Œ)",
          body,
          createdAt: serverTimestamp()
        });
        titleInput.value = "";
        bodyInput.value = "";
        titleInput.focus();
        setStatus("è¿½åŠ ã—ã¾ã—ãŸï¼");
      } catch (e) {
        console.error(e);
        setStatus("è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆFirestoreãƒ«ãƒ¼ãƒ«/æ¨©é™ï¼‰ã€‚", true);
      } finally {
        addBtn.disabled = false;
      }
    }

    addBtn.addEventListener("click", addMemo);

    // ===== å…¨å‰Šé™¤ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ã¿è¡¨ç¤ºï¼‰=====
    async function deleteAll() {
      if (!currentUser) return;
      if (!confirm("å…¨ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;

      setStatus("å…¨å‰Šé™¤ä¸­â€¦");
      try {
        const snap = await getDocs(query(memosCol(currentUser.uid)));
        const batch = writeBatch(db);
        let count = 0;
        snap.forEach(d => { batch.delete(d.ref); count++; });
        if (count === 0) { setStatus("å‰Šé™¤ã™ã‚‹ãƒ¡ãƒ¢ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"); return; }
        await batch.commit();
        setStatus(`å…¨å‰Šé™¤ã—ã¾ã—ãŸï¼ˆ${count}ä»¶ï¼‰ã€‚`);
      } catch (e) {
        console.error(e);
        setStatus("å…¨å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", true);
      }
    }
    deleteAllBtn.addEventListener("click", deleteAll);

    reloadBtn.addEventListener("click", () => location.reload());

    // ===== Auth =====
    loginBtn.addEventListener("click", async () => {
      setStatus("ãƒ­ã‚°ã‚¤ãƒ³ä¸­â€¦");
      await signInWithRedirect(auth, provider);
    });
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆæˆ»ã‚Šï¼ˆå¤±æ•—ã—ã¦ã‚‚ç„¡è¦–ã§OKï¼‰
    try { await getRedirectResult(auth); } catch {}

    // ===== ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã§è³¼èª­é–‹å§‹ =====
    onAuthStateChanged(auth, (user) => {
      currentUser = user;

      if (unsubscribe) { unsubscribe(); unsubscribe = null; }
      cache = [];
      render();

      if (!user) {
        loginBtn.classList.remove("hidden");
        logoutBtn.classList.add("hidden");
        deleteAllBtn.classList.add("hidden");
        userInfo.textContent = "";
        setStatus("æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã™ã€‚Googleã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚", true);
        return;
      }

      loginBtn.classList.add("hidden");
      logoutBtn.classList.remove("hidden");
      deleteAllBtn.classList.remove("hidden");
      userInfo.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${user.displayName ?? ""}`;

      const q = query(memosCol(user.uid), orderBy("createdAt", "desc"));
      setStatus("åŒæœŸä¸­â€¦");

      unsubscribe = onSnapshot(q, (snap) => {
        cache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        render();
      }, (err) => {
        console.error(err);
        setStatus("èª­ã¿è¾¼ã¿ã«å¤±æ•—ï¼ˆFirestoreãƒ«ãƒ¼ãƒ«/è¨­å®šã‚’ç¢ºèªï¼‰ã€‚", true);
      });
    });
  </script>
</body>
</html>
