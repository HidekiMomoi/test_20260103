<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>„É°„É¢ÔºàFirebaseÔºâ</title>
  <style>
    :root { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; }
    body { margin: 0; background:#f7f7fb; color:#111; }
    .wrap { max-width: 980px; margin: 20px auto; padding: 0 14px 40px; }
    h1 { font-size: 30px; margin: 10px 0 14px; display:flex; align-items:center; gap:10px; }
    h1 span { font-size: 34px; }
    .card { background:#fff; border:1px solid #e6e6ef; border-radius:14px; padding:14px; box-shadow: 0 6px 18px rgba(0,0,0,.04); }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:stretch; }
    input[type="text"]{
      flex: 1 1 320px; padding:12px 12px; border:1px solid #d7d7e5; border-radius:10px; font-size:16px;
    }
    textarea{
      width:100%; min-height: 130px; padding:12px 12px; border:1px solid #d7d7e5; border-radius:10px; font-size:16px;
      resize: vertical;
    }
    button{
      padding:12px 14px; border:1px solid #d7d7e5; background:#fff; border-radius:10px; font-size:16px; cursor:pointer;
    }
    button.primary{ background:#2d6cdf; color:#fff; border-color:#2d6cdf; }
    button.danger{ border-color:#ff4d6d; color:#ff4d6d; }
    .tools { margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .small{ font-size:12px; color:#777; }
    .warn{ color:#b34b00; }
    .hidden{ display:none; }

    .grid { display:grid; grid-template-columns: 1fr 160px; gap:10px; margin-top:10px; }
    @media (max-width: 720px){
      .grid { grid-template-columns: 1fr; }
    }

    .list { margin-top:14px; display:flex; flex-direction:column; gap:10px; }
    .memo {
      background:#fff; border:1px solid #e6e6ef; border-radius:14px; padding:12px;
      display:flex; gap:12px; align-items:flex-start;
    }
    .memoMain { flex:1; min-width: 0; }
    .memoTitle { font-size:18px; font-weight:700; margin:0 0 6px; word-break: break-word; }
    .memoBody { font-size:15px; margin:0; white-space: pre-wrap; word-break: break-word; }
    .meta { margin-top:8px; font-size:12px; color:#666; display:flex; gap:10px; flex-wrap:wrap; }
    .badge { font-size:12px; padding:2px 8px; border-radius:999px; background:#f0f1ff; border:1px solid #dde0ff; color:#3a42c6; }
    .footer{ font-size:13px; color:#666; margin-top:12px; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1><span>üóíÔ∏è</span> „É°„É¢ÔºàFirebaseÔºâ</h1>

    <div class="card">
      <div class="row">
        <input id="titleInput" type="text" placeholder="„Çø„Ç§„Éà„É´Ôºà‰æãÔºöÁµåË≤ªÁ≤æÁÆó / PANET„É°„É¢ / ÈÄ£Áµ°‰∫ãÈ†ÖÔºâ" />
      </div>

      <div class="grid">
        <textarea id="bodyInput" placeholder="Êú¨ÊñáÔºà‰æãÔºö12/1 Êê≠‰πóÂàÜ„ÅÆÈ†òÂèéÊõ∏„ÅåÂ±ä„ÅÑ„Å¶„Åã„ÇâÁµåË≤ªÁî≥Ë´ã„Åô„ÇãÔºâ"></textarea>
        <button id="addBtn" class="primary">ËøΩÂä†</button>
      </div>

      <div class="tools">
        <input id="searchInput" type="text" placeholder="Ê§úÁ¥¢Ôºà„Çø„Ç§„Éà„É´„ÉªÊú¨ÊñáÔºâ" />
        <button id="reloadBtn">ÂÜçË™≠„ÅøËæº„Åø</button>
        <button id="deleteAllBtn" class="danger">ÂÖ®ÂâäÈô§</button>

        <button id="loginBtn">Google„Åß„É≠„Ç∞„Ç§„É≥</button>
        <button id="logoutBtn" class="hidden">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>

        <span id="userInfo" class="small"></span>
        <span id="status" class="small"></span>
      </div>

      <div id="list" class="list"></div>

      <div class="footer">
        ‚Äª „Éá„Éº„Çø„ÅØ <b>Firebase Firestore</b> „Å´‰øùÂ≠ò„Åï„Çå„Åæ„ÅôÔºàËá™ÂàÜ„ÅÆ„Éá„Éº„Çø„ÅÆ„ÅøÔºâ„ÄÇ<br/>
        ‚Äª Ê§úÁ¥¢„ÅØÁîªÈù¢‰∏ä„ÅÆÁµû„ÇäËæº„ÅøÔºàÈ´òÈÄüÔºâ„Åß„Åô„ÄÇ
      </div>
    </div>
  </div>

  <script type="module">
    // ---- Firebase SDKÔºàCDN / ES ModulesÔºâ
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithRedirect,
      getRedirectResult,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    import {
      getFirestore,
      collection,
      addDoc,
      deleteDoc,
      doc,
      onSnapshot,
      query,
      orderBy,
      serverTimestamp,
      getDocs,
      writeBatch
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ---- Â§ñ„Å†„Åó config
    import { firebaseConfig } from "./firebase-config.js";

    // ---- init
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // ---- DOM
    const titleInput  = document.getElementById("titleInput");
    const bodyInput   = document.getElementById("bodyInput");
    const addBtn      = document.getElementById("addBtn");
    const searchInput = document.getElementById("searchInput");
    const reloadBtn   = document.getElementById("reloadBtn");
    const deleteAllBtn= document.getElementById("deleteAllBtn");
    const loginBtn    = document.getElementById("loginBtn");
    const logoutBtn   = document.getElementById("logoutBtn");
    const userInfoEl  = document.getElementById("userInfo");
    const statusEl    = document.getElementById("status");
    const listEl      = document.getElementById("list");

    function setStatus(text, isWarn=false){
      statusEl.textContent = text;
      statusEl.className = "small" + (isWarn ? " warn" : "");
    }
    function escapeHtml(s){
      return (s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function memosCol(uid){
      return collection(db, "users", uid, "memos");
    }

    // ---- UI handlers
    reloadBtn.addEventListener("click", () => location.reload());

    loginBtn.addEventListener("click", async () => {
      setStatus("„É≠„Ç∞„Ç§„É≥‰∏≠‚Ä¶");
      await signInWithRedirect(auth, provider);
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      setStatus("„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü„ÄÇ");
    });

    // ---- add memo
    async function addMemo(currentUser){
      const title = titleInput.value.trim();
      const body  = bodyInput.value.trim();

      if (!title && !body){
        setStatus("„Çø„Ç§„Éà„É´„ÅãÊú¨Êñá„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", true);
        return;
      }

      addBtn.disabled = true;
      setStatus("ËøΩÂä†‰∏≠‚Ä¶");

      try{
        await addDoc(memosCol(currentUser.uid), {
          title,
          body,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });

        titleInput.value = "";
        bodyInput.value = "";
        titleInput.focus();
        setStatus("ËøΩÂä†„Åó„Åæ„Åó„ÅüÔºÅ");
      }catch(e){
        console.error(e);
        setStatus("ËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„ÅüÔºàFirestore„É´„Éº„É´/Ê®©ÈôêÔºâ„ÄÇ", true);
      }finally{
        addBtn.disabled = false;
      }
    }

    // ---- delete one
    async function deleteOne(uid, id){
      try{
        await deleteDoc(doc(db, "users", uid, "memos", id));
      }catch(e){
        console.error(e);
        setStatus("ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ", true);
      }
    }

    // ---- delete all
    async function deleteAll(uid){
      if (!confirm("ÂÖ®ÂâäÈô§„Åó„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü")) return;
      setStatus("ÂÖ®ÂâäÈô§‰∏≠‚Ä¶");

      try{
        const snap = await getDocs(query(memosCol(uid)));
        if (snap.empty){
          setStatus("ÂâäÈô§„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ");
          return;
        }

        const batch = writeBatch(db);
        let count = 0;
        snap.forEach(d => {
          batch.delete(doc(db, "users", uid, "memos", d.id));
          count++;
        });
        await batch.commit();
        setStatus(`ÂÖ®ÂâäÈô§„Åó„Åæ„Åó„ÅüÔºà${count}‰ª∂Ôºâ„ÄÇ`);
      }catch(e){
        console.error(e);
        setStatus("ÂÖ®ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ", true);
      }
    }

    deleteAllBtn.addEventListener("click", () => {
      const u = auth.currentUser;
      if (!u){
        setStatus("Êú™„É≠„Ç∞„Ç§„É≥„Åß„Åô„ÄÇ", true);
        return;
      }
      deleteAll(u.uid);
    });

    // ---- render
    function renderList(uid, docs){
      const kw = (searchInput.value || "").trim().toLowerCase();

      listEl.innerHTML = "";
      let shown = 0;

      for (const item of docs){
        const title = item.title ?? "";
        const body  = item.body ?? "";
        const hit = !kw || (title.toLowerCase().includes(kw) || body.toLowerCase().includes(kw));
        if (!hit) continue;

        shown++;
        const div = document.createElement("div");
        div.className = "memo";

        div.innerHTML = `
          <div class="memoMain">
            <div class="memoTitle">${escapeHtml(title || "(ÁÑ°È°å)")}</div>
            <p class="memoBody">${escapeHtml(body)}</p>
            <div class="meta">
              <span class="badge">memo</span>
              <span>id: ${escapeHtml(item.id)}</span>
            </div>
          </div>
          <button class="danger">ÂâäÈô§</button>
        `;

        div.querySelector("button").addEventListener("click", () => deleteOne(uid, item.id));
        listEl.appendChild(div);
      }

      if (docs.length === 0){
        setStatus("„É°„É¢„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ");
        return;
      }
      setStatus(`Ë°®Á§∫‰∏≠Ôºö${shown}‰ª∂ÔºàÂÖ®${docs.length}‰ª∂Ôºâ`);
    }

    // ---- auth + subscribe
    let unsubscribe = null;
    let cacheDocs = [];

    // „É™„ÉÄ„Ç§„É¨„ÇØ„ÉàÂæ©Â∏∞ÔºàÂ§±Êïó„Åó„Å¶„ÇÇOKÔºâ
    try{ await getRedirectResult(auth); }catch(e){}

    onAuthStateChanged(auth, (user) => {
      if (unsubscribe){
        unsubscribe();
        unsubscribe = null;
      }
      cacheDocs = [];
      listEl.innerHTML = "";

      if (!user){
        loginBtn.classList.remove("hidden");
        logoutBtn.classList.add("hidden");
        userInfoEl.textContent = "";
        setStatus("Êú™„É≠„Ç∞„Ç§„É≥„Åß„Åô„ÄÇGoogle„Åß„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", true);

        // Êú™„É≠„Ç∞„Ç§„É≥ÊôÇ„ÅØËøΩÂä†„Éú„Çø„É≥„ÇÇÁÑ°ÂäπÂåñ
        addBtn.disabled = true;
        return;
      }

      // „É≠„Ç∞„Ç§„É≥ÊôÇUI
      loginBtn.classList.add("hidden");
      logoutBtn.classList.remove("hidden");
      userInfoEl.textContent = `„É≠„Ç∞„Ç§„É≥‰∏≠Ôºö${user.displayName ?? ""}`;
      addBtn.disabled = false;

      // ËøΩÂä†
      addBtn.onclick = () => addMemo(user);

      // FirestoreË≥ºË™≠Ôºà‰ΩúÊàêÊó•ÊôÇ„ÅÆÈôçÈ†ÜÔºâ
      const q = query(
        memosCol(user.uid),
        orderBy("createdAt", "desc")
      );

      setStatus("ÂêåÊúü‰∏≠‚Ä¶");

      unsubscribe = onSnapshot(q, (snapshot) => {
        cacheDocs = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        renderList(user.uid, cacheDocs);
      }, (err) => {
        console.error(err);
        setStatus("Ë™≠„ÅøËæº„Åø„Å´Â§±ÊïóÔºàFirestore„É´„Éº„É´/Ë®≠ÂÆöÔºâ„ÄÇ", true);
      });

      // Ê§úÁ¥¢
      searchInput.addEventListener("input", () => renderList(user.uid, cacheDocs));
    });
  </script>
</body>
</html>
