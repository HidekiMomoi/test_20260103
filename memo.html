<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ãƒ¡ãƒ¢ï¼ˆFirebaseï¼‰</title>
  <style>
    :root { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; }
    body { margin: 0; background:#f7f7fb; color:#111; }
    .wrap { max-width: 980px; margin: 18px auto; padding: 0 12px 32px; }
    h1 { font-size: 26px; margin: 8px 0 12px; display:flex; align-items:center; gap:10px; }
    h1 span { font-size: 30px; }
    .card { background:#fff; border:1px solid #e6e6ef; border-radius:14px; padding:12px; box-shadow: 0 6px 18px rgba(0,0,0,.04); }

    /* compact inputs */
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    input[type="text"], textarea, select{
      padding:10px 10px; border:1px solid #d7d7e5; border-radius:10px; font-size:14px; background:#fff;
    }
    textarea{ width:100%; min-height:110px; resize:vertical; }
    button{
      padding:10px 12px; border:1px solid #d7d7e5; background:#fff; border-radius:10px; font-size:14px; cursor:pointer;
      line-height:1;
    }
    button.primary{ background:#2d6cdf; color:#fff; border-color:#2d6cdf; }
    button.danger{ border-color:#ff4d6d; color:#ff4d6d; }
    button.ghost{ background:#f7f7fb; }

    .small{ font-size:12px; color:#777; }
    .warn{ color:#b34b00; }
    .hidden{ display:none; }

    /* layout */
    .grid { display:grid; grid-template-columns: 1fr 180px; gap:10px; }
    @media (max-width: 820px){ .grid{ grid-template-columns: 1fr; } }

    .filterGrid{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr 220px 1fr;
      gap:8px;
      align-items:center;
    }
    @media (max-width: 900px){ .filterGrid{ grid-template-columns: 1fr; } }

    /* tools collapsible */
    details.box{
      margin-top:10px;
      border:1px solid #e6e6ef;
      border-radius:12px;
      padding:8px 10px;
      background:#fafaff;
    }
    details.box > summary{
      cursor:pointer; user-select:none; font-size:13px; color:#444;
      list-style:none; display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    details.box > summary::-webkit-details-marker{ display:none; }
    .boxInner{ margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    /* list */
    .list{ margin-top:12px; display:flex; flex-direction:column; gap:10px; }
    .item{ background:#fff; border:1px solid #e6e6ef; border-radius:14px; padding:10px; display:flex; gap:12px; align-items:flex-start; }
    .itemMain{ flex:1; min-width:0; }
    .itemTitle{ font-size:16px; font-weight:700; margin-bottom:4px; }
    .itemBody{ white-space:pre-wrap; color:#222; line-height:1.5; font-size:14px; }
    .meta{ margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    .pill{ font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid #dde0ff; background:#f0f1ff; color:#3a42c6; user-select:none; }
    .pill.cat { border-color:#d8f1df; background:#f1fff4; color:#1d7a35; }
    .pill.tag { border-color:#ffe2b5; background:#fff7ea; color:#9a5b00; cursor:pointer; }
    .pill.tag.active { outline: 2px solid rgba(154,91,0,.25); }

    .btnCol{ display:flex; gap:8px; align-items:center; }
    .btnCol button{ padding:8px 10px; font-size:13px; }

    .footer{ font-size:12px; color:#666; margin-top:10px; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1><span>ğŸ—’ï¸</span> ãƒ¡ãƒ¢ï¼ˆFirebaseï¼‰</h1>

    <div class="card">
      <!-- Input -->
      <div class="grid">
        <div>
          <div class="row">
            <input id="titleInput" type="text" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä¾‹ï¼šPANET / é€£çµ¡ / çµŒè²»ï¼‰" style="flex:1 1 360px;" />
          </div>

          <div class="row" style="margin-top:8px;">
            <textarea id="bodyInput" placeholder="æœ¬æ–‡"></textarea>
          </div>

          <div class="row" style="margin-top:8px;">
            <select id="categoryInput" style="flex: 0 0 220px;">
              <option value="">ã‚«ãƒ†ã‚´ãƒªï¼ˆæœªè¨­å®šï¼‰</option>
            </select>
            <input id="tagsInput" type="text" placeholder="ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰ä¾‹ï¼šç”³è«‹,æ€¥ã" style="flex:1 1 260px;" />
            <button id="manageCatBtn" class="ghost">ã‚«ãƒ†ã‚´ãƒªç®¡ç†</button>
          </div>
        </div>

        <div class="row" style="justify-content:flex-end; align-items:stretch; flex-direction:column;">
          <button id="addBtn" class="primary" style="width:100%; min-height:42px;">è¿½åŠ </button>
          <button id="cancelEditBtn" class="hidden" style="width:100%;">ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button id="clearInputBtn" class="ghost" style="width:100%;">å…¥åŠ›ã‚¯ãƒªã‚¢</button>
        </div>
      </div>

      <!-- Filters -->
      <div class="filterGrid">
        <input id="searchInput" type="text" placeholder="æ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãƒ»æœ¬æ–‡ãƒ»ã‚¿ã‚°ãƒ»ã‚«ãƒ†ã‚´ãƒªï¼‰" />
        <select id="filterCategory">
          <option value="">ã‚«ãƒ†ã‚´ãƒªï¼šã™ã¹ã¦</option>
        </select>
        <input id="filterTags" type="text" placeholder="ã‚¿ã‚°çµã‚Šè¾¼ã¿ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰ä¾‹ï¼šç”³è«‹,æ€¥ã" />
      </div>

      <div class="row" style="margin-top:8px;">
        <button id="clearFilterBtn" class="ghost">çµã‚Šè¾¼ã¿ã‚¯ãƒªã‚¢</button>
        <button id="reloadBtn">å†èª­ã¿è¾¼ã¿</button>
        <span id="status" class="small"></span>
      </div>

      <!-- Category manager (collapsible style but controlled by button) -->
      <details id="catBox" class="box hidden">
        <summary>
          <span>ğŸ“ ã‚«ãƒ†ã‚´ãƒªç®¡ç†</span>
          <span class="small">ï¼ˆè‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ï¼‰</span>
        </summary>
        <div class="boxInner">
          <input id="newCatInput" type="text" placeholder="æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªåï¼ˆä¾‹ï¼šçµŒè²» / PANET / é€£çµ¡ï¼‰" />
          <button id="addCatBtn" class="primary">è¿½åŠ </button>
          <button id="closeCatBtn">é–‰ã˜ã‚‹</button>
        </div>
        <div class="small" style="margin-top:6px;">â€» æ—¢å­˜ã‚«ãƒ†ã‚´ãƒªã¯ã€Œå¤‰æ›´ã€ã€Œå‰Šé™¤ã€ãŒã§ãã¾ã™ï¼ˆå‰Šé™¤ã—ã¦ã‚‚ãƒ¡ãƒ¢ã¯æ¶ˆãˆã¾ã›ã‚“ï¼‰ã€‚</div>
        <div id="catList" style="margin-top:8px; display:flex; flex-direction:column; gap:8px;"></div>
      </details>

      <!-- Tools -->
      <details class="box">
        <summary>
          <span>âš™ï¸ ãƒ„ãƒ¼ãƒ« / ãƒ­ã‚°ã‚¤ãƒ³</span>
          <span id="userInfo" class="small"></span>
        </summary>
        <div class="boxInner">
          <button id="loginBtn">Googleãƒ­ã‚°ã‚¤ãƒ³</button>
          <button id="logoutBtn" class="hidden">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
          <button id="deleteAllBtn" class="danger">å…¨å‰Šé™¤</button>
        </div>
        <div class="small" style="margin-top:6px;">
          ğŸ’¡ ã‚¿ã‚°ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€Œã‚¿ã‚°çµã‚Šè¾¼ã¿ã€ã«è¿½åŠ /è§£é™¤ã§ãã¾ã™ã€‚
        </div>
      </details>

      <div id="list" class="list"></div>

      <div class="footer">
        â€» ãƒ‡ãƒ¼ã‚¿ã¯ Firebase Firestore ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆè‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ï¼‰ã€‚<br/>
        â€» æ¤œç´¢/çµã‚Šè¾¼ã¿ã¯ç”»é¢ä¸Šã§é«˜é€Ÿã«å®Ÿè¡Œã—ã¾ã™ã€‚
      </div>
    </div>
  </div>

  <script type="module">
    import { firebaseConfig } from "./config.js";
    import {
      createFirebaseContext, onUser, signInGoogle, signOutGoogle,
      setStatusFactory, escapeHtml, normalize, parseTags,
      memosCol, catsCol, memoDoc, catDoc
    } from "./app.js";

    import {
      addDoc, deleteDoc, updateDoc, onSnapshot, query, orderBy,
      serverTimestamp, getDocs, writeBatch
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const { db, auth, provider } = createFirebaseContext(firebaseConfig);

    // DOM
    const titleInput = document.getElementById("titleInput");
    const bodyInput = document.getElementById("bodyInput");
    const categoryInput = document.getElementById("categoryInput");
    const tagsInput = document.getElementById("tagsInput");

    const addBtn = document.getElementById("addBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    const clearInputBtn = document.getElementById("clearInputBtn");

    const manageCatBtn = document.getElementById("manageCatBtn");
    const catBox = document.getElementById("catBox");
    const newCatInput = document.getElementById("newCatInput");
    const addCatBtn = document.getElementById("addCatBtn");
    const closeCatBtn = document.getElementById("closeCatBtn");
    const catListEl = document.getElementById("catList");

    const searchInput = document.getElementById("searchInput");
    const filterCategory = document.getElementById("filterCategory");
    const filterTags = document.getElementById("filterTags");

    const clearFilterBtn = document.getElementById("clearFilterBtn");
    const reloadBtn = document.getElementById("reloadBtn");
    const deleteAllBtn = document.getElementById("deleteAllBtn");

    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const userInfo = document.getElementById("userInfo");
    const statusEl = document.getElementById("status");
    const listEl = document.getElementById("list");

    const setStatus = setStatusFactory(statusEl);

    // state
    let currentUser = null;
    let unsubscribeMemos = null;
    let unsubscribeCats = null;

    let allMemos = [];    // {id,title,body,category,tags}
    let categories = [];  // {id,name}
    let editingId = null;

    // --------- UI helpers ----------
    function setEditMode(m) {
      if (!m) {
        editingId = null;
        addBtn.textContent = "è¿½åŠ ";
        cancelEditBtn.classList.add("hidden");
        return;
      }
      editingId = m.id;
      titleInput.value = m.title ?? "";
      bodyInput.value = m.body ?? "";
      categoryInput.value = m.category ?? "";
      tagsInput.value = (m.tags ?? []).join(",");
      addBtn.textContent = "æ›´æ–°";
      cancelEditBtn.classList.remove("hidden");
      titleInput.focus();
      setStatus("ç·¨é›†ä¸­ï¼šæ›´æ–°ãƒœã‚¿ãƒ³ã§ä¿å­˜ã§ãã¾ã™ã€‚");
    }

    function clearInputs(msg=true) {
      titleInput.value = "";
      bodyInput.value = "";
      categoryInput.value = "";
      tagsInput.value = "";
      setEditMode(null);
      if (msg) setStatus("å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚");
      titleInput.focus();
    }

    function clearFilters(msg=true) {
      searchInput.value = "";
      filterCategory.value = "";
      filterTags.value = "";
      applyFilterAndRender();
      if (msg) setStatus("çµã‚Šè¾¼ã¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚");
    }

    // --------- category ----------
    function renderCategorySelects() {
      const cur1 = categoryInput.value;
      const cur2 = filterCategory.value;

      categoryInput.innerHTML = `<option value="">ã‚«ãƒ†ã‚´ãƒªï¼ˆæœªè¨­å®šï¼‰</option>`;
      filterCategory.innerHTML = `<option value="">ã‚«ãƒ†ã‚´ãƒªï¼šã™ã¹ã¦</option>`;

      for (const c of categories) {
        const o1 = document.createElement("option");
        o1.value = c.name; o1.textContent = c.name;
        categoryInput.appendChild(o1);

        const o2 = document.createElement("option");
        o2.value = c.name; o2.textContent = c.name;
        filterCategory.appendChild(o2);
      }

      categoryInput.value = Array.from(categoryInput.options).some(o => o.value === cur1) ? cur1 : "";
      filterCategory.value = Array.from(filterCategory.options).some(o => o.value === cur2) ? cur2 : "";
    }

    function renderCategoryPanel() {
      catListEl.innerHTML = "";
      if (categories.length === 0) {
        const d = document.createElement("div");
        d.className = "small";
        d.textContent = "ã‚«ãƒ†ã‚´ãƒªã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚è¿½åŠ ã—ã¦ãã ã•ã„ã€‚";
        catListEl.appendChild(d);
        return;
      }

      for (const c of categories) {
        const row = document.createElement("div");
        row.style.display = "flex";
        row.style.gap = "8px";
        row.style.alignItems = "center";
        row.innerHTML = `
          <input type="text" value="${escapeHtml(c.name)}" />
          <button data-rename="1">å¤‰æ›´</button>
          <button data-del="1" class="danger">å‰Šé™¤</button>
        `;
        const inp = row.querySelector("input");

        row.querySelector("[data-rename]").addEventListener("click", async () => {
          if (!currentUser) return;
          const newName = normalize(inp.value);
          if (!newName) return setStatus("ã‚«ãƒ†ã‚´ãƒªåãŒç©ºã§ã™ã€‚", true);
          const dup = categories.some(x => x.name === newName && x.id !== c.id);
          if (dup) return setStatus("åŒåã‚«ãƒ†ã‚´ãƒªãŒæ—¢ã«ã‚ã‚Šã¾ã™ã€‚", true);

          try {
            await updateDoc(catDoc(db, currentUser.uid, c.id), { name: newName });
            setStatus("ã‚«ãƒ†ã‚´ãƒªåã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚");
          } catch (e) {
            console.error(e);
            setStatus("ã‚«ãƒ†ã‚´ãƒªå¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", true);
          }
        });

        row.querySelector("[data-del]").addEventListener("click", async () => {
          if (!currentUser) return;
          if (!confirm(`ã‚«ãƒ†ã‚´ãƒªã€Œ${c.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;

          try {
            await deleteDoc(catDoc(db, currentUser.uid, c.id));
            setStatus("ã‚«ãƒ†ã‚´ãƒªã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
          } catch (e) {
            console.error(e);
            setStatus("ã‚«ãƒ†ã‚´ãƒªå‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", true);
          }
        });

        catListEl.appendChild(row);
      }
    }

    manageCatBtn.addEventListener("click", () => {
      catBox.classList.toggle("hidden");
      if (!catBox.classList.contains("hidden")) catBox.open = true;
    });
    closeCatBtn.addEventListener("click", () => catBox.classList.add("hidden"));

    addCatBtn.addEventListener("click", async () => {
      if (!currentUser) return setStatus("æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã™ã€‚", true);
      const name = normalize(newCatInput.value);
      if (!name) return setStatus("ã‚«ãƒ†ã‚´ãƒªåãŒç©ºã§ã™ã€‚", true);
      const dup = categories.some(c => c.name === name);
      if (dup) return setStatus("åŒåã‚«ãƒ†ã‚´ãƒªãŒæ—¢ã«ã‚ã‚Šã¾ã™ã€‚", true);

      try {
        await addDoc(catsCol(db, currentUser.uid), { name, createdAt: serverTimestamp() });
        newCatInput.value = "";
        setStatus("ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚");
      } catch (e) {
        console.error(e);
        setStatus("ã‚«ãƒ†ã‚´ãƒªè¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", true);
      }
    });

    // --------- memo filter + render ----------
    function applyFilterAndRender() {
      const q = normalize(searchInput.value).toLowerCase();
      const cat = normalize(filterCategory.value);
      const needTags = parseTags(filterTags.value).map(t => t.toLowerCase());

      const filtered = allMemos.filter(m => {
        if (cat && (m.category ?? "") !== cat) return false;

        if (needTags.length > 0) {
          const mtags = (m.tags ?? []).map(t => String(t ?? "").toLowerCase());
          for (const t of needTags) if (!mtags.includes(t)) return false;
        }

        if (!q) return true;
        const hay = [
          (m.title ?? ""),
          (m.body ?? ""),
          (m.category ?? ""),
          ...(m.tags ?? [])
        ].join("\n").toLowerCase();
        return hay.includes(q);
      });

      listEl.innerHTML = "";
      if (filtered.length === 0) {
        setStatus(allMemos.length === 0 ? "ãƒ¡ãƒ¢ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚" : "è©²å½“ãªã—ï¼ˆæ¤œç´¢/çµã‚Šè¾¼ã¿æ¡ä»¶ã‚’è¦‹ç›´ã—ã¦ã­ï¼‰");
        return;
      }

      for (const m of filtered) {
        const el = document.createElement("div");
        el.className = "item";

        const catPill = m.category ? `<span class="pill cat">ğŸ“ ${escapeHtml(m.category)}</span>` : `<span class="pill">ğŸ“ æœªè¨­å®š</span>`;
        const tagPills = (m.tags ?? []).map(t => {
          const low = String(t ?? "").toLowerCase();
          const active = needTags.includes(low);
          return `<span class="pill tag ${active ? "active" : ""}" data-tag="${escapeHtml(t)}">#${escapeHtml(t)}</span>`;
        }).join("");

        el.innerHTML = `
          <div class="itemMain">
            <div class="itemTitle">${escapeHtml(m.title || "(ç„¡é¡Œ)")}</div>
            <div class="itemBody">${escapeHtml(m.body || "")}</div>
            <div class="meta">${catPill}${tagPills}</div>
          </div>
          <div class="btnCol">
            <button data-edit="1">ç·¨é›†</button>
            <button data-del="1" class="danger">å‰Šé™¤</button>
          </div>
        `;

        // tag click -> toggle into filterTags
        el.querySelectorAll("[data-tag]").forEach(tagEl => {
          tagEl.addEventListener("click", () => {
            const tag = normalize(tagEl.getAttribute("data-tag"));
            if (!tag) return;

            const cur = parseTags(filterTags.value);
            const exists = cur.some(x => x.toLowerCase() === tag.toLowerCase());
            const next = exists
              ? cur.filter(x => x.toLowerCase() !== tag.toLowerCase())
              : [...cur, tag];

            filterTags.value = next.join(",");
            applyFilterAndRender();
          });
        });

        el.querySelector("[data-edit]").addEventListener("click", () => setEditMode(m));

        el.querySelector("[data-del]").addEventListener("click", async () => {
          if (!currentUser) return;
          if (!confirm("ã“ã®ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
          try {
            await deleteDoc(memoDoc(db, currentUser.uid, m.id));
            if (editingId === m.id) setEditMode(null);
          } catch (e) {
            console.error(e);
            setStatus("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", true);
          }
        });

        listEl.appendChild(el);
      }

      setStatus(`è¡¨ç¤ºä¸­ï¼š${filtered.length}ä»¶ï¼ˆå…¨ ${allMemos.length}ä»¶ï¼‰`);
    }

    searchInput.addEventListener("input", applyFilterAndRender);
    filterCategory.addEventListener("change", applyFilterAndRender);
    filterTags.addEventListener("input", applyFilterAndRender);

    // --------- add / update ----------
    async function upsertMemo() {
      if (!currentUser) return setStatus("æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã™ã€‚Googleãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­ã€‚", true);

      const title = normalize(titleInput.value);
      const body  = normalize(bodyInput.value);
      const category = normalize(categoryInput.value);
      const tags = parseTags(tagsInput.value);

      if (!title && !body) return setStatus("ã‚¿ã‚¤ãƒˆãƒ«ã‹æœ¬æ–‡ã©ã¡ã‚‰ã‹ã¯å…¥åŠ›ã—ã¦ã­ã€‚", true);

      addBtn.disabled = true;
      setStatus(editingId ? "æ›´æ–°ä¸­â€¦" : "è¿½åŠ ä¸­â€¦");

      try {
        if (!editingId) {
          await addDoc(memosCol(db, currentUser.uid), {
            title, body, category, tags,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          });
          clearInputs(false);
          setStatus("è¿½åŠ ã—ã¾ã—ãŸï¼");
        } else {
          await updateDoc(memoDoc(db, currentUser.uid, editingId), {
            title, body, category, tags,
            updatedAt: serverTimestamp()
          });
          clearInputs(false);
          setStatus("æ›´æ–°ã—ã¾ã—ãŸï¼");
        }
      } catch (e) {
        console.error(e);
        setStatus(`è¿½åŠ /æ›´æ–°ã«å¤±æ•—: ${e?.code || e?.message}`, true);
      } finally {
        addBtn.disabled = false;
      }
    }

    addBtn.addEventListener("click", upsertMemo);

    cancelEditBtn.addEventListener("click", () => {
      clearInputs(false);
      setStatus("ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚");
    });

    clearInputBtn.addEventListener("click", () => clearInputs(true));
    clearFilterBtn.addEventListener("click", () => clearFilters(true));
    reloadBtn.addEventListener("click", () => location.reload());

    // --------- delete all ----------
    async function deleteAllMemos() {
      if (!currentUser) return;
      if (!confirm("ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¢ã‚’å…¨å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;

      setStatus("å…¨å‰Šé™¤ä¸­â€¦");
      try {
        const snap = await getDocs(query(memosCol(db, currentUser.uid)));
        const batch = writeBatch(db);
        let count = 0;
        snap.forEach(d => { batch.delete(d.ref); count++; });

        if (count === 0) return setStatus("å‰Šé™¤ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");

        await batch.commit();
        clearInputs(false);
        setStatus(`å…¨å‰Šé™¤ã—ã¾ã—ãŸï¼ˆ${count}ä»¶ï¼‰`);
      } catch (e) {
        console.error(e);
        setStatus(`å…¨å‰Šé™¤ã«å¤±æ•—: ${e?.code || e?.message}`, true);
      }
    }
    deleteAllBtn.addEventListener("click", deleteAllMemos);

    // --------- auth ----------
    loginBtn.addEventListener("click", async () => {
      try {
        setStatus("ãƒ­ã‚°ã‚¤ãƒ³ä¸­â€¦");
        await signInGoogle(auth, provider);
      } catch (e) {
        console.error(e);
        setStatus(`ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ${e?.code || e?.message}`, true);
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOutGoogle(auth);
    });

    // --------- subscribe ----------
    onUser(auth, (user) => {
      currentUser = user;

      if (unsubscribeMemos) { unsubscribeMemos(); unsubscribeMemos = null; }
      if (unsubscribeCats)  { unsubscribeCats();  unsubscribeCats  = null; }

      allMemos = [];
      categories = [];
      listEl.innerHTML = "";
      renderCategorySelects();
      renderCategoryPanel();
      clearFilters(false);
      clearInputs(false);

      if (!user) {
        loginBtn.classList.remove("hidden");
        logoutBtn.classList.add("hidden");
        userInfo.textContent = "";
        setStatus("æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã™ã€‚âš™ï¸ã‹ã‚‰Googleãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­", true);
        return;
      }

      loginBtn.classList.add("hidden");
      logoutBtn.classList.remove("hidden");
      userInfo.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${user.displayName ?? ""}`;

      // categories
      unsubscribeCats = onSnapshot(query(catsCol(db, user.uid), orderBy("name")), (snap) => {
        categories = snap.docs
          .map(d => ({ id: d.id, name: String(d.data()?.name ?? "") }))
          .filter(c => c.name);
        renderCategorySelects();
        renderCategoryPanel();
        applyFilterAndRender();
      }, (err) => {
        console.error(err);
        setStatus("ã‚«ãƒ†ã‚´ãƒªèª­ã¿è¾¼ã¿ã«å¤±æ•—ï¼ˆãƒ«ãƒ¼ãƒ«/æ¨©é™ï¼‰ã€‚", true);
      });

      // memos
      setStatus("åŒæœŸä¸­â€¦");
      unsubscribeMemos = onSnapshot(query(memosCol(db, user.uid), orderBy("createdAt", "desc")), (snap) => {
        allMemos = snap.docs.map(d => {
          const data = d.data() || {};
          return {
            id: d.id,
            title: data.title ?? "",
            body: data.body ?? "",
            category: data.category ?? "",
            tags: Array.isArray(data.tags) ? data.tags : []
          };
        });
        applyFilterAndRender();
      }, (err) => {
        console.error(err);
        setStatus("ãƒ¡ãƒ¢èª­ã¿è¾¼ã¿ã«å¤±æ•—ï¼ˆãƒ«ãƒ¼ãƒ«/æ¨©é™ï¼‰ã€‚", true);
      });
    });
  </script>
</body>
</html>
