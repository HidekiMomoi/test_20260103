<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ãƒ¡ãƒ¢ï¼ˆFirebaseï¼‰</title>
  <style>
    :root { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; }
    body { margin:0; background:#f7f7fb; color:#111; }
    .wrap { max-width: 980px; margin: 18px auto; padding: 0 12px 32px; }

    /* Header */
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin: 8px 0 12px; }
    h1 { font-size: 26px; margin:0; display:flex; align-items:center; gap:10px; }
    h1 span { font-size: 30px; }
    .nav a{
      text-decoration:none; color:#2d6cdf; font-size:13px;
      border:1px solid #d7d7e5; padding:8px 10px; border-radius:10px; background:#fff;
      display:inline-flex; align-items:center; gap:6px;
    }

    .card { background:#fff; border:1px solid #e6e6ef; border-radius:14px; padding:12px; box-shadow: 0 6px 18px rgba(0,0,0,.04); }

    /* Compact controls */
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    input[type="text"], textarea, select{
      padding:10px 10px;
      border:1px solid #d7d7e5;
      border-radius:10px;
      font-size:14px;
      background:#fff;
      width:100%;
      box-sizing:border-box;
    }
    textarea{ min-height: 120px; resize: vertical; line-height:1.5; }
    button{
      padding:9px 12px;
      border:1px solid #d7d7e5;
      background:#fff;
      border-radius:10px;
      font-size:14px;
      cursor:pointer;
      line-height:1;
    }
    button.primary{ background:#2d6cdf; color:#fff; border-color:#2d6cdf; }
    button.danger{ border-color:#ff4d6d; color:#ff4d6d; }
    button.ghost{ background:#f7f7fb; }
    .small{ font-size:12px; color:#777; }
    .warn{ color:#b34b00; }
    .hidden{ display:none; }

    /* Layout */
    .grid2{
      display:grid;
      grid-template-columns: 1fr 220px;
      gap:10px;
      align-items:stretch;
      margin-top:10px;
    }
    @media (max-width: 860px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .subgrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
      margin-top:8px;
      align-items:center;
    }
    @media (max-width: 860px){
      .subgrid{ grid-template-columns: 1fr; }
    }

    /* Tools collapse */
    details.toolsBox{
      margin-top:10px;
      border:1px solid #e6e6ef;
      border-radius:12px;
      padding:8px 10px;
      background:#fafaff;
    }
    details.toolsBox > summary{
      cursor:pointer;
      user-select:none;
      font-size:13px;
      color:#444;
      list-style:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    details.toolsBox > summary::-webkit-details-marker{ display:none; }
    .toolsInner{ margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    /* List */
    .list{ list-style:none; padding:0; margin:12px 0 0; display:flex; flex-direction:column; gap:10px; }
    .item{
      background:#fff; border:1px solid #e6e6ef; border-radius:14px;
      padding:12px; display:flex; gap:10px; align-items:flex-start;
    }
    .main{ flex:1; min-width:0; display:flex; flex-direction:column; gap:6px; }
    .ttl{ font-size:17px; font-weight:700; word-break:break-word; }
    .body{ font-size:14px; color:#222; white-space:pre-wrap; word-break:break-word; line-height:1.55; }
    .meta{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .chip{
      font-size:12px; padding:2px 8px; border-radius:999px;
      border:1px solid #dde0ff; background:#f0f1ff; color:#3a42c6;
      cursor:pointer; user-select:none;
    }
    .chip.cat{ border-color:#c9f5d3; background:#f1fff4; color:#1d7a35; }
    .chip.tag{ border-color:#ffdca8; background:#fff6e8; color:#8a5a00; }
    .btnCol{ display:flex; flex-direction:column; gap:8px; }
    .btnCol button{ padding:8px 10px; font-size:13px; }

    /* status line */
    .statusLine{ margin-top:8px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <h1><span>ğŸ—’ï¸</span> ãƒ¡ãƒ¢ï¼ˆFirebaseï¼‰</h1>
      <div class="nav">
        <a href="./index.html">ğŸ  ãƒ›ãƒ¼ãƒ </a>
        <a href="./task.html">âœ… ã‚¿ã‚¹ã‚¯ã¸</a>
      </div>
    </div>

    <div class="card">
      <!-- Input area -->
      <div class="grid2">
        <div>
          <input id="titleInput" type="text" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä¾‹ï¼šçµŒè²»ç²¾ç®— / PANETãƒ¡ãƒ¢ / é€£çµ¡äº‹é …ï¼‰" />
          <div style="height:8px;"></div>
          <textarea id="bodyInput" placeholder="æœ¬æ–‡ï¼ˆä¾‹ï¼š12/1 æ­ä¹—åˆ†ã®é ˜åæ›¸ãŒå±Šã„ãŸã‚‰çµŒè²»ç”³è«‹ã™ã‚‹ï¼‰"></textarea>

          <div class="subgrid">
            <select id="categorySelect"></select>
            <input id="tagsInput" type="text" placeholder="ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰ ä¾‹ï¼šé ˜åæ›¸,ç”³è«‹" />
          </div>
        </div>

        <div class="row" style="align-items:stretch; justify-content:flex-end;">
          <button id="addBtn" class="primary" style="height:100%;">è¿½åŠ </button>
          <button id="updateBtn" class="primary hidden" style="height:100%;">æ›´æ–°</button>
          <button id="cancelEditBtn" class="hidden" style="height:100%;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button id="clearInputBtn" class="ghost" style="height:100%;">å…¥åŠ›ã‚¯ãƒªã‚¢</button>
        </div>
      </div>

      <!-- Filters -->
      <div class="subgrid" style="margin-top:10px;">
        <input id="searchInput" type="text" placeholder="æ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãƒ»æœ¬æ–‡ãƒ»ã‚¿ã‚°ãƒ»ã‚«ãƒ†ã‚´ãƒªï¼‰" />
        <select id="filterCategory"></select>
      </div>
      <div class="subgrid">
        <input id="filterTags" type="text" placeholder="ã‚¿ã‚°çµã‚Šè¾¼ã¿ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰ ä¾‹ï¼šç”³è«‹,æ€¥ã" />
        <button id="clearFilterBtn" class="ghost">çµã‚Šè¾¼ã¿ã‚¯ãƒªã‚¢</button>
      </div>

      <div class="statusLine">
        <span id="status" class="small"></span>
        <span id="userInfo" class="small"></span>
      </div>

      <!-- Tools -->
      <details class="toolsBox">
        <summary>
          <span>âš™ï¸ ãƒ„ãƒ¼ãƒ« / ç®¡ç†</span>
          <span class="small">ï¼ˆå‰Šé™¤ã‚„ã‚«ãƒ†ã‚´ãƒªç·¨é›†ãªã©ã¯ã“ã“ï¼‰</span>
        </summary>
        <div class="toolsInner">
          <button id="reloadBtn">å†èª­è¾¼</button>
          <button id="deleteAllBtn" class="danger">å…¨å‰Šé™¤</button>
          <button id="manageCategoriesBtn">ã‚«ãƒ†ã‚´ãƒªç®¡ç†</button>
          <button id="logoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
        <div class="small" style="margin-top:6px;">
          ğŸ’¡ ã‚«ãƒ†ã‚´ãƒª/ã‚¿ã‚°ã®ãƒãƒƒãƒ—ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãã®æ¡ä»¶ã§çµã‚Šè¾¼ã¿ã¾ã™ã€‚
        </div>
      </details>

      <ul id="list" class="list"></ul>

      <div class="small" style="margin-top:10px;">
        â€» ãƒ‡ãƒ¼ã‚¿ã¯ Firestore ã«ä¿å­˜ï¼ˆè‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ï¼‰<br/>
        â€» æ¤œç´¢ã¯ç”»é¢ä¸Šã®çµã‚Šè¾¼ã¿ï¼ˆé«˜é€Ÿï¼‰ã§ã™
      </div>
    </div>
  </div>

  <!-- Category modal (simple prompt style) -->
  <script type="module">
    import { firebaseConfig } from "./config.js";
    import {
      createFirebaseContext, onUser, signOutGoogle,
      setStatusFactory, escapeHtml, normalize
    } from "./app.js";

    import {
      addDoc, deleteDoc, updateDoc, onSnapshot, query, orderBy, serverTimestamp,
      getDocs, writeBatch, collection, doc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const { db, auth } = createFirebaseContext(firebaseConfig);

    // DOM
    const titleInput = document.getElementById("titleInput");
    const bodyInput  = document.getElementById("bodyInput");
    const categorySelect = document.getElementById("categorySelect");
    const tagsInput  = document.getElementById("tagsInput");

    const addBtn = document.getElementById("addBtn");
    const updateBtn = document.getElementById("updateBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    const clearInputBtn = document.getElementById("clearInputBtn");

    const searchInput = document.getElementById("searchInput");
    const filterCategory = document.getElementById("filterCategory");
    const filterTags = document.getElementById("filterTags");
    const clearFilterBtn = document.getElementById("clearFilterBtn");

    const listEl = document.getElementById("list");
    const statusEl = document.getElementById("status");
    const userInfo = document.getElementById("userInfo");

    const reloadBtn = document.getElementById("reloadBtn");
    const deleteAllBtn = document.getElementById("deleteAllBtn");
    const manageCategoriesBtn = document.getElementById("manageCategoriesBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    const setStatus = setStatusFactory(statusEl);

    // state
    let uid = null;
    let unsubMemos = null;
    let unsubCats = null;

    let memos = []; // {id,title,body,category,tags[]}
    let categories = []; // [{id,name}]
    let editingId = null;

    // paths
    const memosCol = (uid) => collection(db, "users", uid, "memos");
    const memoDoc  = (uid, id) => doc(db, "users", uid, "memos", id);
    const catsCol  = (uid) => collection(db, "users", uid, "categories");
    const catDoc   = (uid, id) => doc(db, "users", uid, "categories", id);

    // helpers
    function parseTags(str){
      const raw = normalize(str);
      if (!raw) return [];
      return raw.split(",").map(s => normalize(s)).filter(Boolean);
    }
    function toTagsText(arr){
      return (arr || []).join(", ");
    }

    function resetInput(){
      titleInput.value = "";
      bodyInput.value = "";
      tagsInput.value = "";
      categorySelect.value = "";
      exitEditMode(false);
      titleInput.focus();
      setStatus("å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚");
    }

    function enterEditMode(m){
      editingId = m.id;
      titleInput.value = m.title || "";
      bodyInput.value = m.body || "";
      tagsInput.value = toTagsText(m.tags || []);
      categorySelect.value = m.category || "";
      addBtn.classList.add("hidden");
      updateBtn.classList.remove("hidden");
      cancelEditBtn.classList.remove("hidden");
      setStatus("ç·¨é›†ä¸­ï¼šæ›´æ–°ã§ä¿å­˜ã—ã¾ã™ã€‚");
      titleInput.focus();
    }
    function exitEditMode(show=true){
      editingId = null;
      addBtn.classList.remove("hidden");
      updateBtn.classList.add("hidden");
      cancelEditBtn.classList.add("hidden");
      if (show) setStatus("ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚");
    }

    function buildCategorySelectOptions(){
      // input select
      categorySelect.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "ã‚«ãƒ†ã‚´ãƒªï¼ˆæœªè¨­å®šï¼‰";
      categorySelect.appendChild(opt0);
      categories.forEach(c => {
        const o = document.createElement("option");
        o.value = c.name;
        o.textContent = c.name;
        categorySelect.appendChild(o);
      });

      // filter select
      filterCategory.innerHTML = "";
      const f0 = document.createElement("option");
      f0.value = "";
      f0.textContent = "ã‚«ãƒ†ã‚´ãƒªçµã‚Šè¾¼ã¿ï¼ˆã™ã¹ã¦ï¼‰";
      filterCategory.appendChild(f0);
      categories.forEach(c => {
        const o = document.createElement("option");
        o.value = c.name;
        o.textContent = c.name;
        filterCategory.appendChild(o);
      });
    }

    function applyFilter(){
      const key = normalize(searchInput.value).toLowerCase();
      const cat = normalize(filterCategory.value);
      const tagFilter = parseTags(filterTags.value).map(x => x.toLowerCase());

      const out = memos.filter(m => {
        if (cat && (m.category || "") !== cat) return false;

        if (tagFilter.length > 0){
          const mtags = (m.tags || []).map(t => t.toLowerCase());
          for (const tf of tagFilter){
            if (!mtags.includes(tf)) return false;
          }
        }

        if (!key) return true;
        const hay = `${m.title}\n${m.body}\n${(m.category||"")}\n${(m.tags||[]).join(",")}`.toLowerCase();
        return hay.includes(key);
      });

      render(out);
    }

    function chip(text, cls, onClick){
      const s = document.createElement("span");
      s.className = `chip ${cls}`;
      s.textContent = text;
      s.addEventListener("click", onClick);
      return s;
    }

    function render(items){
      listEl.innerHTML = "";
      if (!uid){
        setStatus("æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã™ã€‚", true);
        return;
      }
      if (items.length === 0){
        setStatus(memos.length === 0 ? "ãƒ¡ãƒ¢ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚" : "è©²å½“ãªã—ï¼ˆæ¤œç´¢/çµã‚Šè¾¼ã¿è¦‹ç›´ã—ï¼‰");
        return;
      }

      items.forEach(m => {
        const li = document.createElement("li");
        li.className = "item";

        const main = document.createElement("div");
        main.className = "main";

        const ttl = document.createElement("div");
        ttl.className = "ttl";
        ttl.textContent = m.title || "(ã‚¿ã‚¤ãƒˆãƒ«ãªã—)";

        const body = document.createElement("div");
        body.className = "body";
        body.textContent = m.body || "";

        const meta = document.createElement("div");
        meta.className = "meta";

        if (m.category){
          meta.appendChild(chip(`ã‚«ãƒ†ã‚´ãƒªï¼š${m.category}`, "cat", () => {
            filterCategory.value = m.category;
            applyFilter();
            setStatus(`ã‚«ãƒ†ã‚´ãƒªã€Œ${m.category}ã€ã§çµã‚Šè¾¼ã¿`);
          }));
        }

        (m.tags || []).forEach(t => {
          meta.appendChild(chip(`#${t}`, "tag", () => {
            const now = parseTags(filterTags.value);
            if (!now.includes(t)) now.push(t);
            filterTags.value = now.join(", ");
            applyFilter();
            setStatus(`ã‚¿ã‚°ã€Œ${t}ã€ã§çµã‚Šè¾¼ã¿`);
          }));
        });

        main.appendChild(ttl);
        main.appendChild(body);
        main.appendChild(meta);

        const btns = document.createElement("div");
        btns.className = "btnCol";
        const editBtn = document.createElement("button");
        editBtn.textContent = "ç·¨é›†";
        editBtn.addEventListener("click", () => enterEditMode(m));

        const delBtn = document.createElement("button");
        delBtn.textContent = "å‰Šé™¤";
        delBtn.className = "danger";
        delBtn.addEventListener("click", async () => {
          try{
            await deleteDoc(memoDoc(uid, m.id));
            if (editingId === m.id) exitEditMode(false);
            setStatus("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
          }catch(e){
            console.error(e);
            setStatus(`å‰Šé™¤å¤±æ•—: ${e?.code || e?.message}`, true);
          }
        });

        btns.appendChild(editBtn);
        btns.appendChild(delBtn);

        li.appendChild(main);
        li.appendChild(btns);
        listEl.appendChild(li);
      });

      setStatus(`è¡¨ç¤ºä¸­ï¼š${items.length}ä»¶ï¼ˆå…¨ ${memos.length}ä»¶ï¼‰`);
    }

    // CRUD
    async function addMemo(){
      if (!uid) return setStatus("æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã™ã€‚", true);

      const title = normalize(titleInput.value);
      const body  = normalize(bodyInput.value);
      const category = normalize(categorySelect.value);
      const tags = parseTags(tagsInput.value);

      if (!title && !body){
        setStatus("ã‚¿ã‚¤ãƒˆãƒ«ã‹æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ã­ã€‚", true);
        titleInput.focus();
        return;
      }

      addBtn.disabled = true;
      setStatus("è¿½åŠ ä¸­â€¦");

      try{
        await addDoc(memosCol(uid), {
          title, body, category,
          tags,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
        resetInput();
        setStatus("è¿½åŠ ã—ã¾ã—ãŸï¼");
      }catch(e){
        console.error(e);
        setStatus(`è¿½åŠ å¤±æ•—: ${e?.code || e?.message}`, true);
      }finally{
        addBtn.disabled = false;
      }
    }

    async function updateMemo(){
      if (!uid || !editingId) return;

      const title = normalize(titleInput.value);
      const body  = normalize(bodyInput.value);
      const category = normalize(categorySelect.value);
      const tags = parseTags(tagsInput.value);

      if (!title && !body){
        setStatus("ã‚¿ã‚¤ãƒˆãƒ«ã‹æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ã­ã€‚", true);
        return;
      }

      updateBtn.disabled = true;
      setStatus("æ›´æ–°ä¸­â€¦");

      try{
        await updateDoc(memoDoc(uid, editingId), {
          title, body, category, tags,
          updatedAt: serverTimestamp()
        });
        resetInput();
        setStatus("æ›´æ–°ã—ã¾ã—ãŸï¼");
      }catch(e){
        console.error(e);
        setStatus(`æ›´æ–°å¤±æ•—: ${e?.code || e?.message}`, true);
      }finally{
        updateBtn.disabled = false;
      }
    }

    // category manage (simple)
    async function manageCategories(){
      if (!uid) return;

      const help =
`ã‚«ãƒ†ã‚´ãƒªç®¡ç†
- ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›ã™ã‚‹ã¨ä¸€æ‹¬è¿½åŠ ã§ãã¾ã™
ä¾‹ï¼šçµŒè²», PANET, é€£çµ¡, ç§ç”¨

å‰Šé™¤ã—ãŸã„å ´åˆã¯ã€Firestoreã® users/{uid}/categories ã‹ã‚‰æ¶ˆã™ã®ãŒç¢ºå®Ÿã§ã™ï¼ˆç°¡å˜ï¼‰ã€‚
`;
      alert(help);

      const input = prompt("è¿½åŠ ã—ãŸã„ã‚«ãƒ†ã‚´ãƒªã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥åŠ›:", "");
      const list = parseTags(input); // åŒã˜å‡¦ç†ã§OK
      if (list.length === 0) return;

      setStatus("ã‚«ãƒ†ã‚´ãƒªè¿½åŠ ä¸­â€¦");
      try{
        for (const name of list){
          // é‡è¤‡å›é¿ï¼ˆUIå´ï¼‰
          if (categories.some(c => c.name === name)) continue;
          await addDoc(catsCol(uid), { name, createdAt: serverTimestamp() });
        }
        setStatus("ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚");
      }catch(e){
        console.error(e);
        setStatus(`ã‚«ãƒ†ã‚´ãƒªè¿½åŠ å¤±æ•—: ${e?.code || e?.message}`, true);
      }
    }

    async function deleteAll(){
      if (!uid) return;
      if (!confirm("ãƒ¡ãƒ¢ã‚’å…¨å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;

      setStatus("å…¨å‰Šé™¤ä¸­â€¦");
      try{
        const snap = await getDocs(query(memosCol(uid)));
        const batch = writeBatch(db);
        let count = 0;
        snap.forEach(d => { batch.delete(d.ref); count++; });
        if (count === 0){ setStatus("å‰Šé™¤ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"); return; }
        await batch.commit();
        exitEditMode(false);
        resetInput();
        setStatus(`å…¨å‰Šé™¤ã—ã¾ã—ãŸï¼ˆ${count}ä»¶ï¼‰`);
      }catch(e){
        console.error(e);
        setStatus(`å…¨å‰Šé™¤å¤±æ•—: ${e?.code || e?.message}`, true);
      }
    }

    // events
    addBtn.addEventListener("click", addMemo);
    updateBtn.addEventListener("click", updateMemo);
    cancelEditBtn.addEventListener("click", () => exitEditMode(true));
    clearInputBtn.addEventListener("click", resetInput);

    searchInput.addEventListener("input", applyFilter);
    filterCategory.addEventListener("change", applyFilter);
    filterTags.addEventListener("input", applyFilter);
    clearFilterBtn.addEventListener("click", () => {
      searchInput.value = "";
      filterCategory.value = "";
      filterTags.value = "";
      applyFilter();
      setStatus("çµã‚Šè¾¼ã¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚");
    });

    reloadBtn.addEventListener("click", () => location.reload());
    deleteAllBtn.addEventListener("click", deleteAll);
    manageCategoriesBtn.addEventListener("click", manageCategories);

    logoutBtn.addEventListener("click", async () => {
      await signOutGoogle(auth);
    });

    // auth & listen
    function stop(){
      if (unsubMemos){ unsubMemos(); unsubMemos = null; }
      if (unsubCats){ unsubCats(); unsubCats = null; }
    }

    onUser(auth, (user) => {
      stop();
      memos = [];
      categories = [];
      listEl.innerHTML = "";
      exitEditMode(false);

      if (!user){
        uid = null;
        userInfo.textContent = "æœªãƒ­ã‚°ã‚¤ãƒ³";
        setStatus("æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã™ã€‚task.html ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‹ã‚‰æˆ»ã£ã¦ãã¦ã‚‚OK", true);
        return;
      }

      uid = user.uid;
      userInfo.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${user.displayName ?? ""}`;

      // categories
      unsubCats = onSnapshot(query(catsCol(uid), orderBy("createdAt")), (snap) => {
        categories = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        categories = categories.filter(c => normalize(c.name));
        buildCategorySelectOptions();
        applyFilter();
      });

      // memos
      unsubMemos = onSnapshot(query(memosCol(uid), orderBy("createdAt")), (snap) => {
        memos = snap.docs.map(d => {
          const data = d.data() || {};
          return {
            id: d.id,
            title: data.title ?? "",
            body: data.body ?? "",
            category: data.category ?? "",
            tags: Array.isArray(data.tags) ? data.tags : []
          };
        }).reverse(); // æ–°ã—ã„ã®ã‚’ä¸Šã«
        applyFilter();
      }, (err) => {
        console.error(err);
        setStatus(`èª­ã¿è¾¼ã¿å¤±æ•—: ${err?.code || err?.message}`, true);
      });

      setStatus("åŒæœŸä¸­â€¦");
    });
  </script>
</body>
</html>
