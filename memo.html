<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ãƒ¡ãƒ¢ï¼ˆFirebaseï¼‰</title>
  <style>
    :root { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; }
    body { margin: 0; background:#f7f7fb; color:#111; }
    .wrap { max-width: 980px; margin: 20px auto; padding: 0 14px 40px; }
    h1 { font-size: 30px; margin: 10px 0 14px; display:flex; align-items:center; gap:10px; }
    h1 span { font-size: 34px; }
    .card { background:#fff; border:1px solid #e6e6ef; border-radius:14px; padding:14px; box-shadow: 0 6px 18px rgba(0,0,0,.04); }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input[type="text"], textarea, select {
      flex: 1 1 280px; padding:12px 12px; border:1px solid #d7d7e5; border-radius:10px; font-size:16px;
      background:#fff;
    }
    textarea { min-height: 120px; resize: vertical; }
    button{ padding:12px 14px; border:1px solid #d7d7e5; background:#fff; border-radius:10px; font-size:16px; cursor:pointer; }
    button.primary{ background:#2d6cdf; color:#fff; border-color:#2d6cdf; }
    button.danger{ border-color:#ff4d6d; color:#ff4d6d; }
    .tools { margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .small{ font-size:12px; color:#777; }
    .warn{ color:#b34b00; }
    .hidden{ display:none; }

    .grid { display:grid; grid-template-columns: 1fr 220px; gap:10px; }
    @media (max-width: 820px){
      .grid{ grid-template-columns: 1fr; }
    }

    .filterRow { margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .filterRow > * { flex: 1 1 220px; }
    .filterRow .btns { flex: 0 0 auto; display:flex; gap:10px; }

    .list { margin-top:12px; display:flex; flex-direction:column; gap:10px; }
    .item { background:#fff; border:1px solid #e6e6ef; border-radius:14px; padding:12px; display:flex; gap:12px; align-items:flex-start; }
    .itemMain { flex: 1; }
    .itemTitle { font-size:18px; font-weight:700; margin-bottom:6px; }
    .itemBody { white-space:pre-wrap; color:#222; line-height:1.5; }
    .meta { margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .pill { font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid #dde0ff; background:#f0f1ff; color:#3a42c6; }
    .pill.cat { border-color:#d8f1df; background:#f1fff4; color:#1d7a35; }
    .pill.tag { border-color:#ffe2b5; background:#fff7ea; color:#9a5b00; }

    .footer{ font-size:13px; color:#666; margin-top:10px; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1><span>ğŸ—’ï¸</span> ãƒ¡ãƒ¢ï¼ˆFirebaseï¼‰</h1>

    <div class="card">
      <div class="grid">
        <div>
          <div class="row">
            <input id="titleInput" type="text" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä¾‹ï¼šçµŒè²»ç²¾ç®— / PANETãƒ¡ãƒ¢ / é€£çµ¡äº‹é …ï¼‰" />
          </div>

          <div class="row" style="margin-top:10px;">
            <textarea id="bodyInput" placeholder="æœ¬æ–‡ï¼ˆä¾‹ï¼š12/1 æ­ä¹—åˆ†ã®é ˜åæ›¸ãŒå±Šã„ã¦ã‹ã‚‰çµŒè²»ç”³è«‹ã™ã‚‹ï¼‰"></textarea>
          </div>

          <div class="row" style="margin-top:10px;">
            <select id="categoryInput">
              <option value="">ã‚«ãƒ†ã‚´ãƒªï¼ˆæœªè¨­å®šï¼‰</option>
              <option value="çµŒè²»">çµŒè²»</option>
              <option value="PANET">PANET</option>
              <option value="é€£çµ¡">é€£çµ¡</option>
              <option value="ç§ç”¨">ç§ç”¨</option>
            </select>
            <input id="tagsInput" type="text" placeholder="ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰ä¾‹ï¼šé ˜åæ›¸,ç”³è«‹,æ€¥ã" />
          </div>
        </div>

        <div class="row" style="justify-content:flex-end; align-items:stretch;">
          <button id="addBtn" class="primary" style="width:100%; height:100%; min-height:120px;">è¿½åŠ </button>
        </div>
      </div>

      <div class="filterRow">
        <input id="searchInput" type="text" placeholder="æ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãƒ»æœ¬æ–‡ãƒ»ã‚¿ã‚°ï¼‰" />
        <select id="filterCategory">
          <option value="">ã‚«ãƒ†ã‚´ãƒªçµã‚Šè¾¼ã¿ï¼ˆã™ã¹ã¦ï¼‰</option>
          <option value="çµŒè²»">çµŒè²»</option>
          <option value="PANET">PANET</option>
          <option value="é€£çµ¡">é€£çµ¡</option>
          <option value="ç§ç”¨">ç§ç”¨</option>
        </select>
        <input id="filterTags" type="text" placeholder="ã‚¿ã‚°çµã‚Šè¾¼ã¿ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰ä¾‹ï¼šç”³è«‹,æ€¥ã" />
        <div class="btns">
          <button id="reloadBtn">å†èª­ã¿è¾¼ã¿</button>
          <button id="deleteAllBtn" class="danger">å…¨å‰Šé™¤</button>
        </div>
      </div>

      <div class="tools">
        <button id="loginBtn">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button id="logoutBtn" class="hidden">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        <span id="userInfo" class="small"></span>
        <span id="status" class="small"></span>
      </div>

      <div id="list" class="list"></div>

      <div class="footer">
        â€» ãƒ‡ãƒ¼ã‚¿ã¯ Firebase Firestore ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆè‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ï¼‰ã€‚<br/>
        â€» æ¤œç´¢ã¯ç”»é¢ä¸Šã®çµã‚Šè¾¼ã¿ï¼ˆé«˜é€Ÿï¼‰ã§ã™ï¼ˆFirestoreã‚¯ã‚¨ãƒªã«ä¾å­˜ã—ã¾ã›ã‚“ï¼‰ã€‚
      </div>
    </div>
  </div>

  <script type="module">
    import { firebaseConfig } from "./config.js";

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithRedirect, getRedirectResult,
      onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, deleteDoc, doc,
      onSnapshot, query, orderBy, serverTimestamp, getDocs, writeBatch
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ---- init
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // ---- DOM
    const titleInput = document.getElementById("titleInput");
    const bodyInput = document.getElementById("bodyInput");
    const categoryInput = document.getElementById("categoryInput");
    const tagsInput = document.getElementById("tagsInput");

    const addBtn = document.getElementById("addBtn");
    const reloadBtn = document.getElementById("reloadBtn");
    const deleteAllBtn = document.getElementById("deleteAllBtn");

    const searchInput = document.getElementById("searchInput");
    const filterCategory = document.getElementById("filterCategory");
    const filterTags = document.getElementById("filterTags");

    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const userInfo = document.getElementById("userInfo");
    const statusEl = document.getElementById("status");
    const listEl = document.getElementById("list");

    function setStatus(text, isWarn=false) {
      statusEl.textContent = text;
      statusEl.className = "small" + (isWarn ? " warn" : "");
    }
    function escapeHtml(s) {
      return (s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
    function normalize(s){ return (s ?? "").toString().trim(); }
    function parseTags(s){
      return normalize(s)
        .split(",")
        .map(x => x.trim())
        .filter(Boolean)
        .slice(0, 30);
    }
    function memosCol(uid) {
      return collection(db, "users", uid, "memos");
    }

    // ---- state
    let currentUser = null;
    let unsubscribe = null;
    let allMemos = []; // {id, title, body, category, tags, createdAt}

    // ---- render + client-side filter
    function applyFilterAndRender() {
      const q = normalize(searchInput.value).toLowerCase();
      const cat = normalize(filterCategory.value);
      const needTags = parseTags(filterTags.value).map(t => t.toLowerCase());

      const filtered = allMemos.filter(m => {
        if (cat && (m.category ?? "") !== cat) return false;

        if (needTags.length > 0) {
          const mtags = (m.tags ?? []).map(t => (t ?? "").toLowerCase());
          // å…¥åŠ›ã—ãŸã‚¿ã‚°ã‚’å…¨éƒ¨å«ã‚€ï¼ˆANDï¼‰
          for (const t of needTags) {
            if (!mtags.includes(t)) return false;
          }
        }

        if (!q) return true;
        const hay = [
          (m.title ?? ""),
          (m.body ?? ""),
          (m.category ?? ""),
          ...(m.tags ?? [])
        ].join("\n").toLowerCase();
        return hay.includes(q);
      });

      listEl.innerHTML = "";
      if (filtered.length === 0) {
        setStatus(allMemos.length === 0 ? "ãƒ¡ãƒ¢ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚" : "è©²å½“ãªã—ï¼ˆæ¤œç´¢/çµã‚Šè¾¼ã¿æ¡ä»¶ã‚’è¦‹ç›´ã—ã¦ã­ï¼‰");
        return;
      }

      for (const m of filtered) {
        const el = document.createElement("div");
        el.className = "item";
        const catPill = m.category ? `<span class="pill cat">ã‚«ãƒ†ã‚´ãƒªï¼š${escapeHtml(m.category)}</span>` : "";
        const tagPills = (m.tags ?? []).map(t => `<span class="pill tag">#${escapeHtml(t)}</span>`).join("");

        el.innerHTML = `
          <div class="itemMain">
            <div class="itemTitle">${escapeHtml(m.title || "(ç„¡é¡Œ)")}</div>
            <div class="itemBody">${escapeHtml(m.body || "")}</div>
            <div class="meta">
              ${catPill}
              ${tagPills}
            </div>
          </div>
          <button data-del="1">å‰Šé™¤</button>
        `;

        el.querySelector("[data-del]").addEventListener("click", async () => {
          if (!currentUser) return;
          try {
            await deleteDoc(doc(db, "users", currentUser.uid, "memos", m.id));
          } catch (e) {
            console.error(e);
            setStatus("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", true);
          }
        });

        listEl.appendChild(el);
      }

      setStatus(`è¡¨ç¤ºä¸­ï¼š${filtered.length}ä»¶ï¼ˆå…¨ ${allMemos.length}ä»¶ï¼‰`);
    }

    searchInput.addEventListener("input", applyFilterAndRender);
    filterCategory.addEventListener("change", applyFilterAndRender);
    filterTags.addEventListener("input", applyFilterAndRender);

    // ---- add
    async function addMemo() {
      if (!currentUser) {
        setStatus("æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã™ã€‚Googleã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚", true);
        return;
      }

      const title = normalize(titleInput.value);
      const body = normalize(bodyInput.value);
      const category = normalize(categoryInput.value);
      const tags = parseTags(tagsInput.value);

      if (!title && !body) {
        setStatus("ã‚¿ã‚¤ãƒˆãƒ«ã‹æœ¬æ–‡ã©ã¡ã‚‰ã‹ã¯å…¥åŠ›ã—ã¦ã­ã€‚", true);
        return;
      }

      addBtn.disabled = true;
      setStatus("è¿½åŠ ä¸­â€¦");

      try {
        await addDoc(memosCol(currentUser.uid), {
          title,
          body,
          category,
          tags,
          createdAt: serverTimestamp()
        });

        titleInput.value = "";
        bodyInput.value = "";
        tagsInput.value = "";
        categoryInput.value = "";
        titleInput.focus();
        setStatus("è¿½åŠ ã—ã¾ã—ãŸï¼");
      } catch (e) {
        console.error(e);
        setStatus("è¿½åŠ å¤±æ•—: permission-denied ãªã‚‰ Firestore ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã€‚", true);
      } finally {
        addBtn.disabled = false;
      }
    }
    addBtn.addEventListener("click", addMemo);

    // ---- delete all (this user only)
    async function deleteAll() {
      if (!currentUser) return;
      if (!confirm("ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¢ã‚’å…¨å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;

      setStatus("å…¨å‰Šé™¤ä¸­â€¦");
      try {
        const snap = await getDocs(query(memosCol(currentUser.uid)));
        const batch = writeBatch(db);
        let count = 0;
        snap.forEach(d => { batch.delete(d.ref); count++; });

        if (count === 0) { setStatus("å‰Šé™¤ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"); return; }

        await batch.commit();
        setStatus(`å…¨å‰Šé™¤ã—ã¾ã—ãŸï¼ˆ${count}ä»¶ï¼‰`);
      } catch (e) {
        console.error(e);
        setStatus("å…¨å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", true);
      }
    }
    deleteAllBtn.addEventListener("click", deleteAll);

    reloadBtn.addEventListener("click", () => location.reload());

    // ---- auth buttons
    loginBtn.addEventListener("click", async () => {
      setStatus("ãƒ­ã‚°ã‚¤ãƒ³ä¸­â€¦");
      await signInWithRedirect(auth, provider);
    });
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    // ---- auth + subscribe
    onAuthStateChanged(auth, async (user) => {
      // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå¾©å¸°ï¼ˆå¿µã®ãŸã‚ï¼‰
      try { await getRedirectResult(auth); } catch (e) {}

      currentUser = user;

      // æ—¢å­˜è³¼èª­è§£é™¤
      if (unsubscribe) { unsubscribe(); unsubscribe = null; }
      allMemos = [];
      listEl.innerHTML = "";

      if (!user) {
        loginBtn.classList.remove("hidden");
        logoutBtn.classList.add("hidden");
        userInfo.textContent = "";
        setStatus("æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã™ã€‚Googleã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚", true);
        return;
      }

      loginBtn.classList.add("hidden");
      logoutBtn.classList.remove("hidden");
      userInfo.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${user.displayName ?? ""}`;

      // Firestoreè³¼èª­ï¼ˆcreatedAt descï¼‰
      const q = query(memosCol(user.uid), orderBy("createdAt", "desc"));
      setStatus("åŒæœŸä¸­â€¦");

      unsubscribe = onSnapshot(q, (snapshot) => {
        allMemos = snapshot.docs.map(d => {
          const data = d.data() || {};
          return {
            id: d.id,
            title: data.title ?? "",
            body: data.body ?? "",
            category: data.category ?? "",
            tags: Array.isArray(data.tags) ? data.tags : [],
            createdAt: data.createdAt ?? null
          };
        });
        applyFilterAndRender();
      }, (err) => {
        console.error(err);
        setStatus("èª­ã¿è¾¼ã¿ã«å¤±æ•—ï¼ˆFirestoreãƒ«ãƒ¼ãƒ«/è¨­å®šã‚’ç¢ºèªï¼‰ã€‚", true);
      });
    });
  </script>
</body>
</html>
